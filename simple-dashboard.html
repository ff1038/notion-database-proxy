<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Test Dashboard</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .loading { 
            text-align: center; 
            color: #666; 
            padding: 40px; 
        }
        .error { 
            color: #dc3545; 
            background: #f8d7da; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 20px 0; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
        }
        .status-info {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="clientTitle">Test Dashboard</h1>
            <p>Simplified version for testing</p>
        </div>
        
        <div class="status-info">
            <strong>Debug Info:</strong>
            <div>User: <span id="userEmail">Loading...</span></div>
            <div>Client: <span id="clientName">Loading...</span></div>
            <div>API Status: <span id="apiStatus">Testing...</span></div>
        </div>
        
        <div id="content">
            <div class="loading">Testing connection...</div>
        </div>
    </div>

    <script>
        console.log("Simple dashboard starting...");
        
        // Replace with your actual Vercel URL
        const PROXY_URL = 'https://notion-database-proxy.vercel.app';
        
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('userEmail') || 'test@test.com';
        
        // Update debug info
        document.getElementById('userEmail').textContent = userEmail;
        
        // Test the connection
        testConnection();
        
        async function testConnection() {
            try {
                console.log("Testing API connection...");
                document.getElementById('apiStatus').textContent = 'Connecting...';
                
                // Test properties endpoint
                const response = await fetch(`${PROXY_URL}/api/simple-notion?userEmail=${encodeURIComponent(userEmail)}&action=properties`);
                
                console.log("Response status:", response.status);
                console.log("Response ok:", response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log("Properties data:", data);
                
                document.getElementById('apiStatus').textContent = 'Connected ✅';
                
                // Now test data endpoint
                loadData();
                
            } catch (error) {
                console.error("Connection test failed:", error);
                document.getElementById('apiStatus').textContent = 'Failed ❌';
                showError(`Connection test failed: ${error.message}`);
            }
        }
        
        async function loadData() {
            try {
                console.log("Loading data...");
                
                const response = await fetch(`${PROXY_URL}/api/simple-notion?userEmail=${encodeURIComponent(userEmail)}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log("Data loaded:", data);
                
                if (data.authorizedClient) {
                    document.getElementById('clientName').textContent = data.authorizedClient;
                    document.getElementById('clientTitle').textContent = `${data.authorizedClient} Dashboard`;
                }
                
                displayData(data);
                
            } catch (error) {
                console.error("Data loading failed:", error);
                showError(`Data loading failed: ${error.message}`);
            }
        }
        
        function displayData(data) {
            const content = document.getElementById('content');
            
            if (!data.results || data.results.length === 0) {
                content.innerHTML = '<p>No data found for this user.</p>';
                return;
            }
            
            // Get all properties (exclude Client)
            const properties = new Set();
            data.results.forEach(record => {
                Object.keys(record.properties).forEach(prop => {
                    if (prop !== 'Client') properties.add(prop);
                });
            });
            
            // Create simple table
            let html = '<h3>Your Data</h3><table><thead><tr>';
            Array.from(properties).forEach(prop => {
                html += `<th>${prop}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Add rows
            data.results.forEach(record => {
                html += '<tr>';
                Array.from(properties).forEach(prop => {
                    const value = getSimpleValue(record.properties[prop]);
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        }
        
        function getSimpleValue(property) {
            if (!property) return '';
            
            switch (property.type) {
                case 'title':
                    return property.title.map(t => t.plain_text).join('');
                case 'rich_text':
                    return property.rich_text.map(t => t.plain_text).join('');
                case 'number':
                    return property.number || '';
                case 'select':
                    return property.select ? property.select.name : '';
                case 'date':
                    return property.date ? new Date(property.date.start).toLocaleDateString() : '';
                case 'checkbox':
                    return property.checkbox ? '✓' : '✗';
                default:
                    return '';
            }
        }
        
        function showError(message) {
            document.getElementById('content').innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
