<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Dashboard</title>
  <style>
    html, body { margin:0; padding:0; background:#f8f9fa; overflow-x:hidden; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    /* Header (full width, but no horizontal overflow) */
    .dashboard-header.merged{
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; padding:18px 22px; border-radius:0; margin:0 0 16px 0; width:100%; box-sizing:border-box;
    }
    .header-left .client-name{ margin:0; font-size:22px; font-weight:600; }
    .header-left .dashboard-subtitle{ margin:4px 0 0; font-size:13px; opacity:.9; }
    .secure-chip{
      display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.25); padding:8px 12px; border-radius:10px; font-size:13px; white-space:nowrap;
      margin-right:8px;        /* inset from right edge */
    }
    .secure-chip .divider{ opacity:.6 }
    @media (max-width:768px){
      .dashboard-header.merged{flex-direction:column; align-items:flex-start; gap:10px;}
      .secure-chip{width:100%; justify-content:space-between; flex-wrap:wrap; margin-right:0;}
    }

    .page { padding:20px; }

    /* Summary */
    .summary-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:20px; }
    .summary-box{ background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); border-left:4px solid #667eea; }
    .summary-title{ font-size:14px; font-weight:600; color:#6c757d; margin-bottom:10px; }
    .summary-value{ font-size:24px; font-weight:700; color:#333; margin-bottom:0; }
    /* hide duplicate small text */
    .summary-breakdown{ display:none; }

    /* Table shell */
    .table-container{ background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); overflow:hidden; }
    .table-header.compact{
      background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e9ecef;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .controls-left{ display:flex; flex:1 1 auto; min-width:320px; }
    .controls-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .filter-buttons.condensed{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .filter-btn{ padding:6px 12px; border:1px solid #dee2e6; border-radius:4px; background:#fff; color:#495057; cursor:pointer; font-size:12px; transition:.2s; }
    .filter-btn:hover{ background:#f8f9fa; border-color:#adb5bd; }
    .filter-btn.active{ background:#667eea; color:#fff; border-color:#667eea; }
    .unpaid-filter{ background:#dc3545; border-color:#dc3545; color:#fff; }
    .unpaid-filter:hover{ background:#c82333; }
    .void-filter{ background:#6c757d; border-color:#6c757d; color:#fff; }
    .void-filter:hover{ background:#5a6268; }

    .search-box{ padding:8px 12px; border:2px solid #dee2e6; border-radius:6px; font-size:14px; width:260px; transition:border-color .3s; }
    .search-box:focus{ outline:none; border-color:#667eea; }

    .export-btn{
      background:#4CAF50; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:14px;
    }
    .export-btn:hover{ background:#45a049; }
    .record-count{ color:#6c757d; font-size:14px; white-space:nowrap; }

    /* Multi-select dropdowns */
    .multi-dropdown{ position:relative; }
    .multi-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border:1px solid #dee2e6; border-radius:4px; background:#fff; color:#495057; cursor:pointer; font-size:12px;
    }
    .multi-btn.active{ border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.15); }
    .multi-menu{
      position:absolute; top:110%; left:0; z-index:50; min-width:220px; max-height:260px; overflow:auto;
      background:#fff; border:1px solid #e9ecef; border-radius:8px; box-shadow:0 12px 24px rgba(0,0,0,.12);
      padding:8px; display:none;
    }
    .multi-item{ display:flex; align-items:center; gap:8px; padding:6px 6px; border-radius:6px; cursor:pointer; }
    .multi-item:hover{ background:#f6f7fb; }
    .multi-actions{ display:flex; gap:8px; justify-content:space-between; padding:6px; border-top:1px solid #eee; margin-top:6px; }
    .chip-count{ font-size:11px; background:#eef2ff; color:#3949ab; border-radius:999px; padding:2px 8px; }

    /* Data table */
    .table-wrapper{ overflow-x:auto; max-height:600px; overflow-y:auto; }
    .data-table{ width:100%; border-collapse:collapse; font-size:14px; }
    .data-table th{
      background:#f8f9fa; padding:15px 12px; text-align:left; font-weight:600; color:#495057;
      border-bottom:2px solid #dee2e6; position:sticky; top:0; z-index:10; cursor:pointer; user-select:none; transition:background-color .2s;
      position: sticky; /* ensure resizer stays inside sticky header */
    }
    .data-table th:hover{ background:#e9ecef; }
    .data-table th .sort-indicator{ display:inline-block; margin-left:5px; opacity:.5; }
    .data-table th.sorted-asc .sort-indicator::after{ content:'‚ñ≤'; opacity:1; }
    .data-table th.sorted-desc .sort-indicator::after{ content:'‚ñº'; opacity:1; }
    .data-table th .sort-indicator::after{ content:'‚Üï'; }
    .data-table td{ padding:12px; border-bottom:1px solid #e9ecef; vertical-align:top; }
    .data-table tr:hover{ background:#f8f9fa; }
    .void-row{ text-decoration:line-through; opacity:.6; background:#f8f9fa !important; }

    /* Column resizer */
    .th-resizer{
      position:absolute; right:0; top:0; height:100%; width:8px;
      cursor:col-resize; user-select:none; -webkit-user-select:none;
      background:transparent;
    }
    .th-resizer:hover{ background:linear-gradient(to right, transparent 0%, rgba(102,126,234,.25) 50%, transparent 100%); }

    .tag{ padding:3px 8px; border-radius:3px; font-size:11px; font-weight:500; display:inline-block; margin:2px; }
    .tag.default{ background:#e9ecef; color:#495057; } .tag.gray{ background:#e9ecef; color:#495057; }
    .tag.brown{ background:#d7ccc8; color:#5d4037; } .tag.orange{ background:#ffe0b2; color:#ef6c00; }
    .tag.yellow{ background:#fff9c4; color:#f57f17; } .tag.green{ background:#c8e6c9; color:#2e7d32; }
    .tag.blue{ background:#bbdefb; color:#1565c0; } .tag.purple{ background:#d1c4e9; color:#512da8; }
    .tag.pink{ background:#f8bbd9; color:#c2185b; } .tag.red{ background:#ffcdd2; color:#d32f2f; }
    .tag.royalties{ background:#e3f2fd; color:#1976d2; } .tag.publishing{ background:#e8f5e8; color:#2e7d32; } .tag.master{ background:#fff3e0; color:#f57c00; }

    .loading{ text-align:center; padding:60px; color:#6c757d; font-size:16px; }
    .error{ text-align:center; padding:40px; color:#721c24; background:#f8d7da; border:1px solid #f5c6cb; border-radius:8px; margin:20px; }
    .no-data{ text-align:center; padding:60px; color:#6c757d; }

    .pagination-container{ display:flex; justify-content:space-between; align-items:center; padding:15px 20px; border-top:1px solid #e9ecef; background:#f8f9fa; }
    .pagination-info{ color:#6c757d; font-size:14px; }
    .pagination-controls{ display:flex; gap:10px; align-items:center; }
    .pagination-btn{ padding:8px 12px; border:1px solid #dee2e6; border-radius:4px; background:#fff; color:#495057; cursor:pointer; font-size:14px; transition:.2s; }
    .pagination-btn:hover:not(:disabled){ background:#f8f9fa; border-color:#adb5bd; }
    .pagination-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .pagination-btn.active{ background:#667eea; color:#fff; border-color:#667eea; }

    .refresh-btn{
      position:fixed; bottom:30px; right:30px; background:#667eea; color:#fff; border:none; border-radius:50%;
      width:60px; height:60px; cursor:pointer; box-shadow:0 4px 20px rgba(102,126,234,.4); font-size:20px; transition:.3s;
    }
    .refresh-btn:hover{ background:#5a6fd8; transform:scale(1.1); }

    @media (max-width:900px){
      .controls-right{ width:100%; justify-content:space-between; }
      .search-box{ flex:1; min-width:180px; }
    }
  </style>
</head>
<body>
  <div class="dashboard-header merged">
    <div class="header-left">
      <h1 class="client-name" id="clientDisplay">Client Dashboard</h1>
      <p class="dashboard-subtitle">Secure data view</p>
    </div>
    <div class="header-right secure-chip">
      <span>üîí Secure access</span>
      <span class="divider">‚Ä¢</span>
      <span>User: <span id="userEmail">Loading...</span></span>
    </div>
  </div>

  <div class="page">

    <!-- Summary -->
    <div class="summary-container" id="summaryContainer" style="display:none;">
      <div class="summary-box">
        <div class="summary-title">Total Income by Currency</div>
        <div class="summary-value" id="totalIncome">Calculating...</div>
        <div class="summary-breakdown" id="totalIncomeBreakdown"></div>
      </div>
      <div class="summary-box">
        <div class="summary-title">Unpaid Income by Currency</div>
        <div class="summary-value" id="unpaidIncome">Calculating...</div>
        <div class="summary-breakdown" id="unpaidIncomeBreakdown"></div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header compact">
        <div class="controls-left">
          <div class="filter-buttons condensed">
            <button class="filter-btn active" onclick="applyDateFilter('all', event)">All Time</button>
            <button class="filter-btn" onclick="applyDateFilter('30', event)">Last 30 Days</button>
            <button class="filter-btn" onclick="applyDateFilter('90', event)">Last 90 Days</button>
            <button class="filter-btn" onclick="applyDateFilter('180', event)">Last 6 Months</button>
            <button class="filter-btn" onclick="applyDateFilter('365', event)">Last 12 Months</button>
            <button class="filter-btn" onclick="applyDateFilter('2025', event)">2025</button>
            <button class="filter-btn" onclick="applyDateFilter('2024', event)">2024</button>
            <button class="filter-btn" onclick="applyDateFilter('2023', event)">2023</button>
            <button class="filter-btn" onclick="applyDateFilter('2022', event)">2022</button>
            <button class="filter-btn" onclick="applyDateFilter('2021', event)">2021</button>

            <button class="filter-btn unpaid-filter" onclick="applyUnpaidFilter()">Unpaid Income</button>
            <button class="filter-btn void-filter" onclick="toggleVoidFilter()">Show Voided</button>

            <!-- Multi-select: Income Types -->
            <div class="multi-dropdown" id="incomeTypeDropdown">
              <button class="multi-btn" id="incomeTypeBtn" type="button" onclick="toggleMulti('income')">
                All Income Types ‚ñæ
              </button>
              <div class="multi-menu" id="incomeTypeMenu">
                <!-- items injected via JS -->
                <div class="multi-actions">
                  <button class="filter-btn" onclick="multiSelectAll('income')">Select all</button>
                  <button class="filter-btn" onclick="multiClear('income')">Clear</button>
                </div>
              </div>
            </div>

            <!-- Multi-select: Currencies -->
            <div class="multi-dropdown" id="currencyDropdown">
              <button class="multi-btn" id="currencyBtn" type="button" onclick="toggleMulti('currency')">
                All Currencies ‚ñæ
              </button>
              <div class="multi-menu" id="currencyMenu">
                <!-- items injected via JS -->
                <div class="multi-actions">
                  <button class="filter-btn" onclick="multiSelectAll('currency')">Select all</button>
                  <button class="filter-btn" onclick="multiClear('currency')">Clear</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="controls-right">
          <input type="text" id="searchBox" class="search-box" placeholder="Search data..." />
          <button class="export-btn" id="exportCsvBtn" onclick="exportCSV()">‚¨á Export CSV</button>
          <span id="recordCount" class="record-count"></span>
        </div>
      </div>

      <div id="tableContent">
        <div class="loading">Loading your data...</div>
      </div>

      <div class="pagination-container" id="paginationContainer" style="display:none;">
        <div class="pagination-info" id="paginationInfo"></div>
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">‚Üê Previous</button>
          <span id="pageNumbers"></span>
          <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <button class="refresh-btn" onclick="loadData()" title="Refresh Data">‚Üª</button>
  </div>

  <script>
    let currentUserEmail = '';
    let currentData = null;
    let filteredData = null;
    let sortOrder = {};
    let currentPage = 1;
    let recordsPerPage = 50;
    let currentDateFilter = 'all';
    let isUnpaidFilter = false;
    let showVoidedItems = false;

    // NEW: multi-select state
    const selectedIncomeTypes = new Set();
    const selectedCurrencies  = new Set();
    let allIncomeTypes = [];
    let allCurrencies  = [];

    /* ------------ Date & simple toggles ------------ */
    function applyDateFilter(filter, evt) {
      document.querySelectorAll('.filter-btn:not(.unpaid-filter):not(.void-filter)').forEach(b=>b.classList.remove('active'));
      if (evt && evt.target) evt.target.classList.add('active');
      currentDateFilter = filter;
      isUnpaidFilter = false;
      const unpaidBtn = document.querySelector('.unpaid-filter');
      if (unpaidBtn) unpaidBtn.classList.remove('active');
      applyFilters();
    }

    function applyUnpaidFilter() {
      isUnpaidFilter = !isUnpaidFilter;
      const btn = document.querySelector('.unpaid-filter');
      if (isUnpaidFilter) {
        btn.classList.add('active');
        document.querySelectorAll('.filter-btn:not(.unpaid-filter):not(.void-filter)').forEach(b=>b.classList.remove('active'));
        currentDateFilter = 'all';
      } else {
        btn.classList.remove('active');
        currentDateFilter = 'all';
        const allBtn = document.querySelector('.filter-btn');
        if (allBtn) allBtn.classList.add('active');
      }
      applyFilters();
    }

    function toggleVoidFilter() {
      showVoidedItems = !showVoidedItems;
      const btn = document.querySelector('.void-filter');
      btn.classList.toggle('active', showVoidedItems);
      btn.textContent = showVoidedItems ? 'Hide Voided' : 'Show Voided';
      applyFilters();
    }

    /* ------------ Multi-select dropdowns ------------ */
    function toggleMulti(kind){
      const btn  = document.getElementById(kind === 'income' ? 'incomeTypeBtn' : 'currencyBtn');
      const menu = document.getElementById(kind === 'income' ? 'incomeTypeMenu' : 'currencyMenu');
      const isOpen = menu.style.display === 'block';
      closeAllMulti();
      if (!isOpen){
        menu.style.display = 'block';
        btn.classList.add('active');
      }
    }
    function closeAllMulti(){
      document.querySelectorAll('.multi-menu').forEach(m => m.style.display='none');
      document.querySelectorAll('.multi-btn').forEach(b => b.classList.remove('active'));
    }
    document.addEventListener('click', (e)=>{
      const dd = e.target.closest('.multi-dropdown');
      if (!dd) closeAllMulti();
    });

    function renderMultiMenus(){
      // Income Type
      const incomeMenu = document.getElementById('incomeTypeMenu');
      incomeMenu.innerHTML = '';
      (allIncomeTypes||[]).forEach(v=>{
        const id = 'inc_' + v.replace(/\W+/g,'_');
        const wrap = document.createElement('label');
        wrap.className = 'multi-item';
        wrap.innerHTML = `<input type="checkbox" id="${id}" ${selectedIncomeTypes.has(v)?'checked':''} />
                          <span>${v}</span>`;
        wrap.querySelector('input').addEventListener('change', (ev)=>{
          ev.target.checked ? selectedIncomeTypes.add(v) : selectedIncomeTypes.delete(v);
          updateMultiLabels();
          applyFilters();
        });
        incomeMenu.appendChild(wrap);
      });
      // actions
      incomeMenu.appendChild(actionRow('income'));

      // Currency
      const curMenu = document.getElementById('currencyMenu');
      curMenu.innerHTML = '';
      (allCurrencies||[]).forEach(v=>{
        const id = 'cur_' + v.replace(/\W+/g,'_');
        const wrap = document.createElement('label');
        wrap.className = 'multi-item';
        wrap.innerHTML = `<input type="checkbox" id="${id}" ${selectedCurrencies.has(v)?'checked':''} />
                          <span>${v}</span>`;
        wrap.querySelector('input').addEventListener('change', (ev)=>{
          ev.target.checked ? selectedCurrencies.add(v) : selectedCurrencies.delete(v);
          updateMultiLabels();
          applyFilters();
        });
        curMenu.appendChild(wrap);
      });
      curMenu.appendChild(actionRow('currency'));

      updateMultiLabels();
    }

    function actionRow(kind){
      const row = document.createElement('div');
      row.className = 'multi-actions';
      const a = document.createElement('button');
      a.className = 'filter-btn';
      a.textContent = 'Select all';
      a.addEventListener('click', ()=>multiSelectAll(kind));
      const b = document.createElement('button');
      b.className = 'filter-btn';
      b.textContent = 'Clear';
      b.addEventListener('click', ()=>multiClear(kind));
      row.appendChild(a); row.appendChild(b);
      return row;
    }

    function multiSelectAll(kind){
      if (kind==='income'){ allIncomeTypes.forEach(v=>selectedIncomeTypes.add(v)); }
      else { allCurrencies.forEach(v=>selectedCurrencies.add(v)); }
      renderMultiMenus();
      applyFilters();
    }
    function multiClear(kind){
      if (kind==='income'){ selectedIncomeTypes.clear(); }
      else { selectedCurrencies.clear(); }
      renderMultiMenus();
      applyFilters();
    }

    function updateMultiLabels(){
      const incBtn = document.getElementById('incomeTypeBtn');
      const curBtn = document.getElementById('currencyBtn');

      if (selectedIncomeTypes.size === 0) incBtn.textContent = 'All Income Types ‚ñæ';
      else incBtn.innerHTML = `${selectedIncomeTypes.size} selected <span class="chip-count">‚ñæ</span>`;

      if (selectedCurrencies.size === 0) curBtn.textContent = 'All Currencies ‚ñæ';
      else curBtn.innerHTML = `${selectedCurrencies.size} selected <span class="chip-count">‚ñæ</span>`;
    }

    /* ------------ Data load / setup ------------ */
    window.addEventListener('load', ()=>{
      const urlParams = new URLSearchParams(window.location.search);
      const userEmail = urlParams.get('userEmail');
      if (!userEmail){ showError('No user specified. Please access through proper link.'); return; }
      currentUserEmail = userEmail;
      const u = document.getElementById('userEmail'); if (u) u.textContent = userEmail;

      const searchBox = document.getElementById('searchBox');
      if (searchBox){ searchBox.addEventListener('input', ()=>applyFilters()); }

      loadData();
    });

    async function loadData(){
      const tableContent = document.getElementById('tableContent');
      tableContent.innerHTML = '<div class="loading">Verifying access and loading your data...</div>';
      try{
        const p = new URLSearchParams(window.location.search);
        const userEmail = p.get('userEmail'); const secureKey = p.get('secureKey'); const timestamp = p.get('timestamp');
        if (!userEmail || !secureKey || !timestamp) throw new Error('Missing authentication parameters');

        const apiUrl = `/api/client-data?userEmail=${encodeURIComponent(userEmail)}&secureKey=${secureKey}&timestamp=${timestamp}`;
        const resp = await fetch(apiUrl, { headers:{ 'Accept':'application/json', 'Cache-Control':'no-cache' } });
        if (!resp.ok){
          let msg = `Access denied: ${resp.status}`;
          try{ const ed = await resp.json(); msg = ed.error || msg; }catch{}
          throw new Error(msg);
        }
        const data = await resp.json();

        if (data.authorizedClient) document.getElementById('clientDisplay').textContent = `${data.authorizedClient} Dashboard`;

        currentData = data;

        // Build multi-select options from metadata
        allIncomeTypes = (data.metadata?.incomeTypes || []).slice().sort();
        allCurrencies  = (data.metadata?.currencies || []).slice().sort();
        renderMultiMenus();

        displayDataAsTable(data);
        updateSummaryBoxes();
      }catch(err){
        console.error(err);
        showError(`Access Denied: ${err.message}<br><br>Please access this dashboard through the official website.`);
      }
    }

    /* ------------ Filtering & table render ------------ */
    function getFilteredDataByDateAndUnpaid(){
      if (!currentData || !currentData.results) return [];
      let filtered = [...currentData.results];

      // hide voided unless toggled on
      if (!showVoidedItems){
        filtered = filtered.filter(r => !(r.properties?.['VOID?']?.checkbox === true));
      }
      // income types
      if (selectedIncomeTypes.size > 0){
        filtered = filtered.filter(r => {
          const v = r.properties?.['Income Type']?.select?.name;
          return v && selectedIncomeTypes.has(v);
        });
      }
      // currencies (prefer invoice currency if present)
      if (selectedCurrencies.size > 0){
        filtered = filtered.filter(r => {
          const v = r.properties?.['Currency (Inv/Stmt)']?.select?.name
                 || r.properties?.['Currency']?.select?.name;
          return v && selectedCurrencies.has(v);
        });
      }
      // date filters
      if (currentDateFilter !== 'all'){
        filtered = filtered.filter(r=>{
          const d = r.properties?.['Invoice date']?.date?.start;
          if (!d) return false;
          const rec = new Date(d); const now = new Date();
          if (currentDateFilter === '30')  return rec >= new Date(now.getTime() - 30 * 864e5);
          if (currentDateFilter === '90')  return rec >= new Date(now.getTime() - 90 * 864e5);
          if (currentDateFilter === '180') return rec >= new Date(now.getTime() - 180* 864e5);
          if (currentDateFilter === '365') return rec >= new Date(now.getTime() - 365* 864e5);
          return rec.getFullYear().toString() === currentDateFilter; // year
        });
      }
      // unpaid
      if (isUnpaidFilter){
        filtered = filtered.filter(r=>{
          const val = r.properties?.['Amount Received']?.number;
          return val === undefined || val === null || val === 0;
        });
      }
      return filtered;
    }

    function applyFilters(){
      if (!currentData) return;
      filteredData = getFilteredDataByDateAndUnpaid();

      const sb = document.getElementById('searchBox');
      const term = (sb?.value || '').toLowerCase().trim();
      if (term){
        filteredData = filteredData.filter(record=>{
          const text = Object.values(record.properties||{}).map(p => String(getPropertyValue(p)).toLowerCase().replace(/<[^>]*>/g,'')).join(' ');
          return text.includes(term);
        });
      }
      currentPage = 1;
      displayDataAsTable(currentData);
      updateSummaryBoxes();
    }

    function displayDataAsTable(data){
      const el = document.getElementById('tableContent');
      if (!data.results || data.results.length===0){ el.innerHTML = '<div class="no-data"><h3>No data found</h3></div>'; return; }

      const disp = filteredData || data.results;
      const totalRecords = disp.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = startIndex + recordsPerPage;
      const pageData = disp.slice(startIndex, endIndex);

      updateRecordCount(pageData.length, totalRecords, startIndex+1, Math.min(endIndex,totalRecords));

      const order = data.columnOrder || [];
      const headers = data.columnHeaders || {};
      let props = [];
      if (order.length){
        props = order.filter(col => data.results.some(r=>r.properties[col]));
      }else{
        const s = new Set();
        data.results.forEach(r => Object.keys(r.properties||{}).forEach(k => { if (k!=='Client') s.add(k); }));
        props = Array.from(s);
      }

      let html = '<div class="table-wrapper"><table class="data-table"><thead><tr>';
      props.forEach(p => { html += `<th data-column="${p}" onclick="sortTable('${p}')">${headers[p]||p}<span class="sort-indicator"></span><span class="th-resizer" onmousedown="startResize(event)"></span></th>`; });
      html += '</tr></thead><tbody>';

      pageData.forEach(rec=>{
        const isVoided = !!(rec.properties?.['VOID?']?.checkbox);
        html += `<tr class="${isVoided?'void-row':''}">`;
        props.forEach(p=>{
          const prop = rec.properties?.[p];
          const val = prop ? getPropertyValue(prop, p) : '';
          html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      el.innerHTML = html;

      updatePagination(totalPages, totalRecords);
      document.getElementById('summaryContainer').style.display = 'grid';
    }

    function updatePagination(totalPages, totalRecords){
      const cont = document.getElementById('paginationContainer');
      const info = document.getElementById('paginationInfo');
      const prev = document.getElementById('prevBtn');
      const next = document.getElementById('nextBtn');
      const nums = document.getElementById('pageNumbers');

      if (totalPages <= 1){ cont.style.display='none'; return; }
      cont.style.display='flex';

      const startRecord = (currentPage-1)*recordsPerPage + 1;
      const endRecord = Math.min(currentPage*recordsPerPage, totalRecords);
      info.textContent = `Showing ${startRecord}-${endRecord} of ${totalRecords} records`;

      prev.disabled = currentPage===1; next.disabled = currentPage===totalPages;

      let html = ''; const show = 5;
      let start = Math.max(1, currentPage - Math.floor(show/2));
      let end   = Math.min(totalPages, start + show - 1);
      if (end - start < show - 1) start = Math.max(1, end - show + 1);
      for (let i=start; i<=end; i++){
        html += `<button class="pagination-btn ${i===currentPage?'active':''}" onclick="goToPage(${i})">${i}</button>`;
      }
      nums.innerHTML = html;
    }
    function changePage(d){ const total = Math.ceil((filteredData || currentData.results).length / recordsPerPage); const n = currentPage + d; if (n>=1 && n<=total){ currentPage=n; displayDataAsTable(currentData); } }
    function goToPage(p){ currentPage = p; displayDataAsTable(currentData); }
    function updateRecordCount(displayed,total,start,end){
      const rc = document.getElementById('recordCount');
      if (start && end) rc.textContent = `${start}-${end} of ${total} records`;
      else if (displayed===total) rc.textContent = `${total} record${total!==1?'s':''}`;
      else rc.textContent = `${displayed} of ${total} record${total!==1?'s':''}`;
    }

    /* ------------ Sorting helpers ------------ */
    function sortTable(column){
      if (!currentData || !currentData.results) return;
      sortOrder[column] = (sortOrder[column] === 'asc') ? 'desc' : 'asc';
      Object.keys(sortOrder).forEach(c=>{
        if (c!==column){ delete sortOrder[c]; const h = document.querySelector(`th[data-column="${c}"]`); if (h) h.classList.remove('sorted-asc','sorted-desc'); }
      });
      document.querySelectorAll('th[data-column]').forEach(h=>{
        const c = h.getAttribute('data-column'); h.classList.remove('sorted-asc','sorted-desc');
        if (c===column) h.classList.add(sortOrder[column]==='asc'?'sorted-asc':'sorted-desc');
      });

      const dataToSort = filteredData || currentData.results;
      dataToSort.sort((a,b)=>{
        const av = getPropertySortValue(a.properties[column]);
        const bv = getPropertySortValue(b.properties[column]);
        if (av === bv) return 0;
        const cmp = av < bv ? -1 : 1;
        return sortOrder[column]==='asc' ? cmp : -cmp;
      });
      if (filteredData) filteredData = dataToSort; else currentData.results = dataToSort;
      currentPage = 1; displayDataAsTable(currentData);
    }

    function getPropertySortValue(p){
      if (!p) return '';
      switch(p.type){
        case 'number': return p.number || 0;
        case 'date':   return p.date ? new Date(p.date.start).getTime() : 0;
        case 'select': return (p.select?.name || '').toLowerCase();
        case 'multi_select': return p.multi_select.map(t=>t.name).join(' ').toLowerCase();
        case 'title':  return p.title.map(t=>t.plain_text).join('').toLowerCase();
        case 'rich_text': return p.rich_text.map(t=>t.plain_text).join('').toLowerCase();
        case 'relation': return (p.relation_titles || '').toLowerCase();
        default: return String(getPropertyValue(p)).toLowerCase().replace(/<[^>]*>/g,'');
      }
    }

    /* ------------ Column resizing ------------ */
    let _resize = null; // { startX, startW, table, colIndex }
    function startResize(e){
      e.preventDefault();
      const th = e.target.closest('th');
      const table = th.closest('table');
      const colIndex = Array.from(th.parentNode.children).indexOf(th);
      _resize = {
        startX: e.clientX,
        startW: th.offsetWidth,
        table,
        colIndex
      };
      document.addEventListener('mousemove', onResizeMove);
      document.addEventListener('mouseup', endResize);
    }
    function onResizeMove(e){
      if (!_resize) return;
      const delta = e.clientX - _resize.startX;
      const newW = Math.max(60, _resize.startW + delta);
      setColumnWidth(_resize.table, _resize.colIndex, newW);
      document.body.style.cursor = 'col-resize';
    }
    function endResize(){
      document.removeEventListener('mousemove', onResizeMove);
      document.removeEventListener('mouseup', endResize);
      _resize = null;
      document.body.style.cursor = '';
    }
    function setColumnWidth(table, idx, px){
      const rows = table.querySelectorAll('tr');
      rows.forEach(r=>{
        const cell = r.children[idx];
        if (cell){
          cell.style.width = px+'px';
          cell.style.minWidth = px+'px';
          cell.style.maxWidth = px+'px';
        }
      });
    }
    // expose so inline onmousedown can call it
    window.startResize = startResize;

    /* ------------ Summary ------------ */
    function getNumberProp(record, keys){
      for (const k of keys){
        const p = record.properties?.[k];
        if (p && p.type==='number' && typeof p.number === 'number') return p.number;
      }
      return null;
    }
    function getSelectNameProp(record, keys){
      for (const k of keys){
        const p = record.properties?.[k];
        if (p && p.type==='select' && p.select?.name) return p.select.name;
      }
      return 'Unknown';
    }
    function updateSummaryBoxes(){
      if (!currentData || !currentData.results) return;
      const rows = filteredData || currentData.results;

      const totalByCurr = {}, unpaidByCurr = {};
      rows.forEach(rec=>{
        if (rec.properties?.['VOID?']?.checkbox === true) return;
        const net = getNumberProp(rec, ['Net Amount','Net']); if (net===null) return;
        const received = getNumberProp(rec, ['Amount Received','Received Amount']);
        const invCurr = getSelectNameProp(rec, ['Currency (Inv/Stmt)','Currency','Currency (Invoice)']);
        totalByCurr[invCurr] = (totalByCurr[invCurr]||0) + net;
        if (received === null || received === 0) unpaidByCurr[invCurr] = (unpaidByCurr[invCurr]||0) + net;
      });

      const totalEntries = Object.entries(totalByCurr);
      document.getElementById('totalIncome').textContent =
        totalEntries.length ? totalEntries.map(([c,a])=>`${c} ${formatNumber(a)}`).join(' ‚Ä¢ ') : 'No data';
      document.getElementById('totalIncomeBreakdown').textContent = '';

      const unpaidEntries = Object.entries(unpaidByCurr);
      document.getElementById('unpaidIncome').textContent =
        unpaidEntries.length ? unpaidEntries.map(([c,a])=>`${c} ${formatNumber(a)}`).join(' ‚Ä¢ ') : 'All paid';
      document.getElementById('unpaidIncomeBreakdown').textContent = '';
    }

    /* ------------ Formatters & cell render ------------ */
    function formatNumber(n){ if (n===null || n===undefined || n==='') return ''; return Number(n).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function formatPercentage(n){ if (n===null || n===undefined || n==='') return ''; return (Number(n)*100).toFixed(2)+'%'; }
    function formatDate(s){ if (!s) return ''; const d = new Date(s); const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return `${String(d.getDate()).padStart(2,'0')} ${m[d.getMonth()]} ${d.getFullYear()}`; }

    function getTagClass(name){
      const k = name.toLowerCase().replace(/\s+/g,'-');
      const map = { 'royalties':'royalties', 'publishing':'publishing', 'master':'master', 'royalties---publishing':'publishing', 'royalties---master':'master' };
      if (map[k]) return map[k];
      const c = { gray:'gray',grey:'gray',brown:'brown',orange:'orange',yellow:'yellow',green:'green',blue:'blue',purple:'purple',pink:'pink',red:'red' };
      for (const [key,val] of Object.entries(c)) if (k.includes(key)) return val;
      const colors = ['blue','green','purple','orange','pink','yellow']; let h=0; for (let i=0;i<name.length;i++){ h = name.charCodeAt(i) + ((h<<5)-h); }
      return colors[Math.abs(h)%colors.length];
    }

    function getPropertyValue(p, columnName){
      if (!p) return '';
      if (columnName==='Commission %' && p.type==='number') return formatPercentage(p.number);
      switch(p.type){
        case 'title': return p.title.map(t=>t.plain_text).join('');
        case 'rich_text': return p.rich_text.map(t=>t.plain_text).join('');
        case 'number': return p.number!==null ? formatNumber(p.number) : '';
        case 'select': return p.select ? `<span class="tag ${getTagClass(p.select.name)}">${p.select.name}</span>` : '';
        case 'multi_select': return p.multi_select.map(t=>`<span class="tag ${getTagClass(t.name)}">${t.name}</span>`).join(' ');
        case 'date': return p.date ? formatDate(p.date.start) : '';
        case 'checkbox': return p.checkbox ? '‚úÖ' : '‚ùå';
        case 'url': return p.url ? `<a href="${p.url}" target="_blank" style="color:#667eea;">üîó Link</a>` : '';
        case 'email': return p.email ? `<a href="mailto:${p.email}" style="color:#667eea;">üìß ${p.email}</a>` : '';
        case 'phone_number': return p.phone_number || '';
        case 'status': return p.status ? `<span class="tag default">${p.status.name}</span>` : '';
        case 'people': return (p.people||[]).map(per=>`üë§ ${per.name}`).join(', ');
        case 'relation':
          if (p.relation && p.relation.length>0){ return p.relation_titles || `${p.relation.length} linked item${p.relation.length!==1?'s':''}`; }
          return '';
        case 'formula': {
          const f = p.formula; if (!f) return '';
          if (f.type==='string') return f.string || '';
          if (f.type==='number') return columnName==='Commission %' ? formatPercentage(f.number) : (f.number!==null ? formatNumber(f.number) : '');
          if (f.type==='boolean') return f.boolean ? '‚úÖ' : '‚ùå';
          if (f.type==='date') return f.date ? formatDate(f.date.start) : '';
          return '';
        }
        case 'rollup': {
          const r = p.rollup; if (!r) return '';
          if (r.type==='number') return columnName==='Commission %' ? formatPercentage(r.number) : (r.number ? formatNumber(r.number) : '');
          if (r.type==='date') return r.date ? formatDate(r.date.start) : '';
          if (r.type==='array'){
            return r.array.map(item=>{
              if (item.type==='number') return item.number ? formatNumber(item.number) : '';
              if (item.type==='rich_text') return item.rich_text.map(t=>t.plain_text).join('');
              if (item.type==='title') return item.title.map(t=>t.plain_text).join('');
              return '';
            }).filter(Boolean).join(', ');
          }
          return '';
        }
        case 'files': return (p.files||[]).length ? `üìé ${p.files.length} file${p.files.length!==1?'s':''}` : '';
        case 'created_time': return formatDate(p.created_time);
        case 'last_edited_time': return formatDate(p.last_edited_time);
        case 'created_by': return p.created_by?.name || 'Unknown';
        case 'last_edited_by': return p.last_edited_by?.name || 'Unknown';
        default: return '';
      }
    }

    function showError(msg){ document.getElementById('tableContent').innerHTML = `<div class="error">${msg}</div>`; }

    /* ------------ CSV Export (kept) ------------ */
    function csvEscape(val){ if (val===null || val===undefined) return '""'; const s=String(val).replace(/\r?\n|\r/g,' ').replace(/"/g,'""'); return `"${s}"`; }
    function getPlainValue(p, col){ if (!p) return ''; switch(p.type){
      case 'title': return p.title.map(t=>t.plain_text).join('');
      case 'rich_text': return p.rich_text.map(t=>t.plain_text).join('');
      case 'number': return p.number ?? '';
      case 'select': return p.select?.name || '';
      case 'multi_select': return p.multi_select.map(t=>t.name).join('; ');
      case 'date': return p.date ? formatDate(p.date.start) : '';
      case 'checkbox': return p.checkbox ? 'TRUE':'FALSE';
      case 'url': return p.url || '';
      case 'email': return p.email || '';
      case 'phone_number': return p.phone_number || '';
      case 'status': return p.status?.name || '';
      case 'people': return (p.people||[]).map(x=>x.name).join('; ');
      case 'relation': return p.relation_titles || (p.relation?.length ? `${p.relation.length} linked` : '');
      case 'formula': {
        const f=p.formula; if (!f) return ''; if (f.type==='string') return f.string||''; if (f.type==='number') return f.number??''; if (f.type==='boolean') return f.boolean?'TRUE':'FALSE'; if (f.type==='date') return f.date?formatDate(f.date.start):''; return '';
      }
      case 'rollup': {
        const r=p.rollup; if (!r) return '';
        if (r.type==='number') return r.number ?? '';
        if (r.type==='date') return r.date?formatDate(r.date.start):'';
        if (r.type==='array'){ return r.array.map(it=>{ if (it.type==='number') return it.number??''; if (it.type==='rich_text') return it.rich_text.map(t=>t.plain_text).join(''); if (it.type==='title') return it.title.map(t=>t.plain_text).join(''); return ''; }).filter(Boolean).join('; '); }
        return '';
      }
      case 'files': return (p.files||[]).map(f=>f.name || f.file?.url || f.external?.url).join('; ');
      case 'created_time': return formatDate(p.created_time);
      case 'last_edited_time': return formatDate(p.last_edited_time);
      case 'created_by': return p.created_by?.name || '';
      case 'last_edited_by': return p.last_edited_by?.name || '';
      default: return '';
    } }
    function getActiveColumns(){
      if (!currentData) return [];
      const data=currentData; const order=data.columnOrder||[];
      if (order.length) return order.filter(col=>data.results.some(r=>r.properties[col]));
      const set=new Set(); data.results.forEach(r=>{ Object.keys(r.properties||{}).forEach(p=>{ if (p!=='Client') set.add(p); }); });
      return Array.from(set);
    }
    function getActiveRows(){ return (filteredData || (currentData ? currentData.results : [])) || []; }
    function exportCSV(){
      try{
        if (!currentData || !currentData.results){ alert('Data not loaded yet.'); return; }
        const cols = getActiveColumns();
        const headersMap = currentData.columnHeaders || {};
        const headerRow = cols.map(c=>csvEscape(headersMap[c]||c)).join(',');
        const rows = getActiveRows();
        const csvLines=[headerRow];
        rows.forEach(rec=>{
          const row = cols.map(col => csvEscape(getPlainValue(rec.properties?.[col], col))).join(',');
          csvLines.push(row);
        });
        const csv = '\uFEFF' + csvLines.join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); const client=(document.getElementById('clientDisplay')?.textContent||'data').replace(/\s+Dashboard$/,'').trim();
        a.href=url; a.download=`dashboard-${client}-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      }catch(e){ console.error('CSV export failed:',e); alert('Sorry, CSV export failed. See console for details.'); }
    }

    // expose needed functions
    window.loadData = loadData;
    window.toggleMulti = toggleMulti;
    window.multiSelectAll = multiSelectAll;
    window.multiClear = multiClear;
    window.goToPage = goToPage;
    window.changePage = changePage;
    window.sortTable = sortTable;
    window.startResize = startResize;
  </script>
</body>
</html>
