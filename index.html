<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Client Dashboard</title>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
  :root{ --gap:16px; --radius:12px; }
  body{ font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; margin:0; background:#f6f7fb; color:#222; }

  /* Header (merged) */
  .dashboard-header{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:#fff;padding:5px 5px;margin:0 0 var(--gap) 0;border-radius:0;
  }
  .header-left h1{margin:0;font-size:22px;font-weight:600}
  .header-left p{margin:4px 0 0;font-size:13px;opacity:.9}
  .secure-chip{display:flex;gap:2px;align-items:center;white-space:nowrap;padding:2px 4px;border-radius:5px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);font-size:13px;}

  .page{padding:20px}

  /* Summary */
  .summary-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  .summary-box{background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:4px solid #667eea;}
  .summary-title{font-size:14px;color:#6c7583;font-weight:600;margin:0 0 8px}
  .summary-value{font-size:26px;font-weight:800;color:#1f2330}

  /* Toolbar */
  .toolbar{
    background:#fff;border-radius:12px;padding:12px 16px;margin-bottom:var(--gap);
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
  }
  .filter-btn{padding:6px 12px;border:1px solid #e0e3ea;border-radius:8px;background:#fff;font-size:12px;cursor:pointer}
  .filter-btn.active{background:#667eea;border-color:#667eea;color:#fff}
  .search-box{border:2px solid #e5e7f1;border-radius:8px;padding:8px 12px;font-size:14px;width:260px}
  .export-btn{background:#2fbf71;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer}
  .spacer{flex:1}

  /* Multi-select dropdown */
  .msel{position:relative}
  .msel-btn{
    display:flex;align-items:center;gap:6px;
    border:1px solid #e0e3ea;background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer
  }
  .msel-panel{
    position:absolute;top:110%;left:0;z-index:20;background:#fff;border:1px solid #e0e3ea;border-radius:10px;
    width:260px;box-shadow:0 10px 30px rgba(24,27,51,.12);padding:8px;display:none;
  }
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid #e6e8f1;border-radius:8px;margin-bottom:8px;font-size:13px}
  .msel-list{max-height:220px;overflow:auto;padding-right:4px}
  .msel-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer}
  .msel-item:hover{background:#f6f7fb}
  .msel-footer{display:flex;justify-content:space-between;gap:8px;margin-top:8px}
  .msel-apply,.msel-clear{flex:1;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
  .msel-apply{background:#667eea;color:#fff}
  .msel-clear{background:#f1f2f8}

  /* Tabs */
  .tabs{display:flex;gap:10px;margin-bottom:var(--gap)}
  .tab-btn{background:#fff;border:1px solid #e0e3ea;border-radius:999px;padding:6px 14px;cursor:pointer}
  .tab-btn.active{background:#2f2e41;color:#fff;border-color:#2f2e41}

  /* Table */
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
  .table-wrapper{overflow:auto;max-height:60vh}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th{position:sticky;top:0;background:#f6f7fb;border-bottom:2px solid #e5e7f1;text-align:left;padding:12px;font-weight:600;cursor:pointer}
  td{border-bottom:1px solid #eef0f5;padding:12px;vertical-align:top}
  tr:hover{background:#fafbff}

  /* Charts grid (2√ó2) */
  .charts-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)}
  .chart-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px 12px 6px;display:flex;flex-direction:column;min-height:330px}
  .chart-title{font-weight:700;margin:4px 8px 6px}
  .chart-wrap{flex:1;min-height:280px}
  @media (max-width:1024px){ .summary-row{grid-template-columns:1fr} .charts-grid{grid-template-columns:1fr} .table-wrapper{max-height:none} }

  .loading{padding:60px;text-align:center;color:#6e7587}
  .error{padding:40px;margin:20px;background:#fde9ec;border:1px solid #f7c9d1;border-radius:12px;color:#8d2a3b;text-align:center}

  /* Colour tags */
  .tag{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-block}
  .tag.blue{background:#e6f0ff;color:#1e5bd9}
  .tag.green{background:#e9f7ef;color:#1f7a43}
  .tag.purple{background:#eee9ff;color:#5c3fd6}
  .tag.orange{background:#fff2e6;color:#c76506}
  .tag.pink{background:#fde6f1;color:#bf2066}
  .tag.yellow{background:#fff8d6;color:#8c6d00}
  .tag.gray{background:#ecf0f3;color:#54616d}
  .tag.gold{background:#fff4d6;color:#a37500}
</style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header">
    <div class="secure-chip">
      <span>üîí Secure access</span><span>‚Ä¢</span>
      <span>User: <span id="userEmail">Loading...</span></span>
    </div>
  </div>

  <div class="page">
    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-title">Total Income by Currency</div>
        <div class="summary-value" id="totalIncome">‚Äî</div>
      </div>
      <div class="summary-box" style="border-left-color:#4b91f1">
        <div class="summary-title">Unpaid Income by Currency</div>
        <div class="summary-value" id="unpaidIncome">‚Äî</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
      <button class="filter-btn active" onclick="applyDateFilter('all',event)">All Time</button>
      <button class="filter-btn" onclick="applyDateFilter('30',event)">Last 30 Days</button>
      <button class="filter-btn" onclick="applyDateFilter('90',event)">Last 90 Days</button>
      <button class="filter-btn" onclick="applyDateFilter('180',event)">Last 6 Months</button>
      <button class="filter-btn" onclick="applyDateFilter('365',event)">Last 12 Months</button>
      <button class="filter-btn" onclick="applyDateFilter('2025',event)">2025</button>
      <button class="filter-btn" onclick="applyDateFilter('2024',event)">2024</button>
      <button class="filter-btn" onclick="applyDateFilter('2023',event)">2023</button>
      <button class="filter-btn" onclick="applyDateFilter('2022',event)">2022</button>
      <button class="filter-btn" onclick="applyDateFilter('2021',event)">2021</button>

      <button class="filter-btn" id="unpaidBtn" onclick="applyUnpaidFilter()">Unpaid Income</button>
      <button class="filter-btn" id="voidBtn" onclick="toggleVoidFilter()">Show Voided</button>

      <!-- Custom multi-selects -->
      <div class="msel" id="msIncomeType"></div>
      <div class="msel" id="msCurrency"></div>

      <div class="spacer"></div>
      <input type="text" class="search-box" id="searchBox" placeholder="Search data‚Ä¶" />
      <button class="export-btn" onclick="exportCSV()">‚¨á Export CSV</button>
      <span id="recordCount" style="color:#6e7587;font-size:14px"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" id="tabTable"  onclick="switchTab('table')">Table</button>
      <button class="tab-btn" id="tabCharts" onclick="switchTab('charts')">Charts</button>
    </div>

    <!-- Charts -->
    <section id="chartsSection" style="display:none">
      <div class="charts-grid">
        <div class="chart-card"><div class="chart-title">Monthly Income Trends</div><div class="chart-wrap" id="chartMonthly"></div></div>
        <div class="chart-card"><div class="chart-title">Income by Currency</div><div class="chart-wrap" id="chartCurrency"></div></div>
        <div class="chart-card"><div class="chart-title">Top Vendors by Income</div><div class="chart-wrap" id="chartVendors"></div></div>
        <div class="chart-card"><div class="chart-title">Income by Type</div><div class="chart-wrap" id="chartType"></div></div>
      </div>
    </section>

    <!-- Table -->
    <section id="tableSection">
      <div class="card">
        <div id="tableContent"><div class="loading">Loading your data‚Ä¶</div></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid #eef0f5">
          <div id="paginationInfo" style="color:#6e7587"></div>
          <div>
            <button class="filter-btn" onclick="changePage(-1)" id="prevBtn">‚Üê Prev</button>
            <span id="pageNumbers"></span>
            <button class="filter-btn" onclick="changePage(1)" id="nextBtn">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Refresh FAB -->
  <button title="Refresh" onclick="loadData()" style="position:fixed;right:24px;bottom:24px;background:#667eea;color:#fff;border:none;width:56px;height:56px;border-radius:50%;box-shadow:0 10px 30px rgba(102,126,234,.35);font-size:20px;cursor:pointer">‚Üª</button>

<script>
/* =================== STATE =================== */
let currentUserEmail = '';
let currentData = null;
let filteredData = null;
let sortOrder = {};
let currentPage = 1;
let recordsPerPage = 50;
let currentDateFilter = 'all';
let isUnpaidFilter = false;
let showVoidedItems = false;

/* Multi-select state (Sets) */
const selectedIncomeTypes = new Set();
const selectedCurrencies  = new Set();

/* =================== TABS =================== */
function switchTab(which){
  const tTable  = document.getElementById('tabTable');
  const tCharts = document.getElementById('tabCharts');
  const sTable  = document.getElementById('tableSection');
  const sCharts = document.getElementById('chartsSection');
  if (which==='charts'){
    tCharts.classList.add('active'); tTable.classList.remove('active');
    sCharts.style.display=''; sTable.style.display='none';
    setTimeout(resizeCharts, 40);
  }else{
    tTable.classList.add('active'); tCharts.classList.remove('active');
    sTable.style.display=''; sCharts.style.display='none';
  }
}

/* =================== FILTER BUTTONS =================== */
function applyDateFilter(filter, evt){
  document.querySelectorAll('.toolbar .filter-btn').forEach(b=>{ if(!b.id) b.classList.remove('active'); });
  if (evt && evt.target) evt.target.classList.add('active');
  currentDateFilter = filter;
  isUnpaidFilter = false; document.getElementById('unpaidBtn').classList.remove('active');
  applyFilters();
}
function applyUnpaidFilter(){
  isUnpaidFilter = !isUnpaidFilter;
  document.getElementById('unpaidBtn').classList.toggle('active',isUnpaidFilter);
  if (isUnpaidFilter){
    currentDateFilter='all';
    document.querySelectorAll('.toolbar .filter-btn').forEach(b=>{ if(!b.id) b.classList.remove('active'); });
  }
  applyFilters();
}
function toggleVoidFilter(){
  showVoidedItems = !showVoidedItems;
  const btn = document.getElementById('voidBtn');
  btn.textContent = showVoidedItems ? 'Hide Voided' : 'Show Voided';
  btn.classList.toggle('active',showVoidedItems);
  applyFilters();
}

/* =================== MULTI-SELECT UI =================== */
function makeMultiSelect(el, {label, options, selectedSet, onApply}){
  el.innerHTML = `
    <button class="msel-btn" type="button"><span>${label}</span><span class="msel-count"></span>‚ñæ</button>
    <div class="msel-panel">
      <input class="msel-search" placeholder="Search‚Ä¶"/>
      <div class="msel-list"></div>
      <div class="msel-footer">
        <button class="msel-clear" type="button">Clear</button>
        <button class="msel-apply" type="button">Apply</button>
      </div>
    </div>
  `;
  const btn    = el.querySelector('.msel-btn');
  const panel  = el.querySelector('.msel-panel');
  const list   = el.querySelector('.msel-list');
  const srch   = el.querySelector('.msel-search');
  const applyB = el.querySelector('.msel-apply');
  const clearB = el.querySelector('.msel-clear');
  const count  = el.querySelector('.msel-count');

  function renderList(filter=''){
    list.innerHTML='';
    options
      .filter(o => !filter || o.toLowerCase().includes(filter.toLowerCase()))
      .forEach(o=>{
        const id = `${label}-${o}`.replace(/\s+/g,'_');
        const row = document.createElement('label');
        row.className='msel-item';
        row.innerHTML = `
          <input type="checkbox" id="${id}" ${selectedSet.has(o)?'checked':''}/>
          <span>${o}</span>
        `;
        row.addEventListener('click', (e)=>{
          if (e.target.tagName !== 'INPUT'){
            const cb = row.querySelector('input'); cb.checked = !cb.checked;
          }
        });
        list.appendChild(row);
      });
  }
  function updateCount(){
    count.textContent = selectedSet.size ? `(${selectedSet.size})` : '';
  }
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.msel').forEach(x=>{ if(x!==el) x.classList.remove('open'); });
    el.classList.toggle('open');
    renderList(); updateCount();
  });
  srch.addEventListener('input', ()=>renderList(srch.value));
  clearB.addEventListener('click', ()=>{
    selectedSet.clear(); renderList(srch.value); updateCount();
  });
  applyB.addEventListener('click', ()=>{
    // rebuild selection from list checkboxes
    selectedSet.clear();
    list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      const text = cb.parentElement.querySelector('span').textContent;
      if (cb.checked) selectedSet.add(text);
    });
    updateCount();
    el.classList.remove('open');
    onApply && onApply();
  });

  // click outside
  document.addEventListener('click', (e)=>{
    if (!el.contains(e.target)) el.classList.remove('open');
  });

  renderList(); updateCount();
}

/* =================== SEARCH =================== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('searchBox').addEventListener('input', applyFilters);
});

/* =================== DATA LOAD =================== */
window.addEventListener('load', ()=>{
  const url = new URLSearchParams(location.search);
  const email = url.get('userEmail'); const key = url.get('secureKey'); const ts = url.get('timestamp');
  if (!email){ showError('No user specified.'); return; }
  currentUserEmail = email; document.getElementById('userEmail').textContent=email;
  loadData(email,key,ts);
});

async function loadData(userEmail, secureKey, timestamp){
  const tableContent = document.getElementById('tableContent');
  tableContent.innerHTML = '<div class="loading">Verifying access and loading your data‚Ä¶</div>';
  try{
    const apiUrl = `/api/client-data?userEmail=${encodeURIComponent(userEmail)}&secureKey=${secureKey}&timestamp=${timestamp}`;
    const resp = await fetch(apiUrl, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    if (!resp.ok){
      let msg=`Access denied: ${resp.status}`; try{ const e=await resp.json(); msg=e.error||msg; }catch{}
      throw new Error(msg);
    }
    const data = await resp.json();
    if (data.authorizedClient) document.getElementById('clientDisplay').textContent = `${data.authorizedClient} Dashboard`;
    currentData = data;

    // Build multi-selects
    makeMultiSelect(
      document.getElementById('msIncomeType'),
      {
        label:'Income Types',
        options:[...(data.metadata?.incomeTypes || [])],
        selectedSet:selectedIncomeTypes,
        onApply:applyFilters
      }
    );
    makeMultiSelect(
      document.getElementById('msCurrency'),
      {
        label:'Currencies',
        options:[...(data.metadata?.currencies || [])],
        selectedSet:selectedCurrencies,
        onApply:applyFilters
      }
    );

    applyFilters();   // builds table, charts, summaries
    switchTab('table');
  }catch(e){ console.error(e); showError(`Access Denied: ${e.message}`); }
}

/* =================== FILTER / REDUCE =================== */
function applyFilters(){
  if (!currentData) return;
  let rows = [...(currentData.results || [])];

  // hide voided unless toggled
  if (!showVoidedItems){
    rows = rows.filter(r => !(r.properties?.['VOID?']?.checkbox === true));
  }

  // multi-select Income Types
  if (selectedIncomeTypes.size){
    rows = rows.filter(r=>{
      const t = r.properties?.['Income Type']?.select?.name;
      return t && selectedIncomeTypes.has(t);
    });
  }

  // multi-select Currencies (invoice currency)
  if (selectedCurrencies.size){
    rows = rows.filter(r=>{
      const c = r.properties?.['Currency (Inv/Stmt)']?.select?.name
             || r.properties?.['Currency']?.select?.name;
      return c && selectedCurrencies.has(c);
    });
  }

  // date range / year
  if (currentDateFilter !== 'all'){
    rows = rows.filter(r=>{
      const d = r.properties?.['Invoice date']?.date?.start;
      if (!d) return false;
      const rec = new Date(d); const now = new Date();
      if (['30','90','180','365'].includes(currentDateFilter)){
        const days = +currentDateFilter;
        return rec >= new Date(now.getTime() - days*24*3600*1000);
      }else{
        return rec.getFullYear().toString() === currentDateFilter;
      }
    });
  }

  // unpaid
  if (isUnpaidFilter){
    rows = rows.filter(r=>{
      const n = r.properties?.['Amount Received']?.number;
      return n==null || n===0;
    });
  }

  // search
  const q = (document.getElementById('searchBox').value || '').toLowerCase().trim();
  if (q){
    rows = rows.filter(rec=>{
      let s=''; Object.values(rec.properties||{}).forEach(p => s += ' ' + getPlainValue(p));
      return s.toLowerCase().includes(q);
    });
  }

  filteredData = rows;

  currentPage = 1;
  displayTable(currentData);
  updateSummaryBoxes();
  updateCharts();
}

/* =================== TABLE =================== */
function displayTable(data){
  const tableContent = document.getElementById('tableContent');
  const rows = filteredData || data.results || [];
  if (!rows.length){
    tableContent.innerHTML = '<div class="loading">No data found.</div>';
    document.getElementById('paginationInfo').textContent='';
    document.getElementById('recordCount').textContent='0 records';
    return;
  }

  const order = data.columnOrder || [];
  let props = [];
  if (order.length){ props = order.filter(c => rows.some(r=>r.properties[c])); }
  else{
    const set=new Set(); rows.forEach(r=>Object.keys(r.properties||{}).forEach(k=>{if(k!=='Client') set.add(k)}));
    props=[...set];
  }

  const totalRecords = rows.length;
  const totalPages = Math.ceil(totalRecords/recordsPerPage);
  const startIndex = (currentPage-1)*recordsPerPage;
  const endIndex = Math.min(startIndex+recordsPerPage,totalRecords);
  const pageData = rows.slice(startIndex,endIndex);

  const headers = data.columnHeaders || {};
  let html = '<div class="table-wrapper"><table><thead><tr>';
  props.forEach(p=> html += `<th data-column="${p}" onclick="sortTable('${p}')">${headers[p]||p}</th>`);
  html += '</tr></thead><tbody>';

  pageData.forEach(rec=>{
    const isVoided = rec.properties?.['VOID?']?.checkbox === true;
    html += `<tr${isVoided?' style="opacity:.6;text-decoration:line-through;background:#fafbff"':''}>`;
    props.forEach(p=>{
      html += `<td>${getDisplayValue(rec.properties?.[p], p)}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  tableContent.innerHTML = html;

  document.getElementById('paginationInfo').textContent = `Showing ${startIndex+1}-${endIndex} of ${totalRecords}`;
  document.getElementById('recordCount').textContent    = `${totalRecords} record${totalRecords!==1?'s':''}`;
  buildPageButtons(totalPages);
}

function sortTable(column){
  const rows = filteredData || currentData.results || [];
  const now  = (sortOrder[column] === 'asc') ? 'desc' : 'asc';
  sortOrder = {[column]:now};
  rows.sort((a,b)=>{
    const av = getSortValue(a.properties?.[column]);
    const bv = getSortValue(b.properties?.[column]);
    if (av===bv) return 0; const cmp = av<bv? -1:1; return now==='asc'? cmp : -cmp;
  });
  currentPage=1; displayTable(currentData);
}
function buildPageButtons(total){
  const cont=document.getElementById('pageNumbers'); cont.innerHTML='';
  const show=Math.min(total,7); let start=Math.max(1,currentPage-Math.floor(show/2)); let end=Math.min(total,start+show-1);
  if (end-start<show-1) start=Math.max(1,end-show+1);
  for (let i=start;i<=end;i++){
    const b=document.createElement('button'); b.className='filter-btn'+(i===currentPage?' active':''); b.textContent=i;
    b.onclick=()=>{currentPage=i;displayTable(currentData);}; cont.appendChild(b);
  }
  document.getElementById('prevBtn').disabled=currentPage===1;
  document.getElementById('nextBtn').disabled=currentPage===total || total===0;
}
function changePage(delta){
  const total = Math.ceil((filteredData||[]).length/recordsPerPage);
  const np = currentPage+delta; if (np>=1 && np<=total){ currentPage=np; displayTable(currentData); }
}

/* =================== VALUE HELPERS + TAG COLOURS =================== */
function formatNumber(n){ return Number(n||0).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function tagClassByName(name, column){
  const n=(name||'').toLowerCase();
  // Income Type suggestions
  if (column==='Income Type'){
    if (n.includes('publishing')) return 'green';
    if (n.includes('master'))     return 'orange';
    if (n.includes('royalties'))  return 'blue';
    if (n.includes('other'))      return 'gray';
    return 'purple';
  }
  // Currency tags
  if (column.startsWith('Currency')){
    if (n==='gbp') return 'gold';
    if (n==='usd') return 'blue';
    if (n==='eur') return 'purple';
    return 'gray';
  }
  return 'gray';
}
function getDisplayValue(prop, columnName){
  if (!prop) return '';
  if (columnName==='Commission %' && prop.type==='number') return (Number(prop.number||0)*100).toFixed(2)+'%';
  switch(prop.type){
    case 'title': return prop.title.map(t=>t.plain_text).join('');
    case 'rich_text': return prop.rich_text.map(t=>t.plain_text).join('');
    case 'number': return prop.number!=null ? formatNumber(prop.number) : '';
    case 'select': {
      if (!prop.select) return '';
      const klass = tagClassByName(prop.select.name, columnName);
      return `<span class="tag ${klass}">${prop.select.name}</span>`;
    }
    case 'multi_select': return prop.multi_select.map(t=>`<span class="tag ${tagClassByName(t.name,columnName)}">${t.name}</span>`).join(' ');
    case 'date': return prop.date ? new Date(prop.date.start).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '';
    case 'checkbox': return prop.checkbox?'‚úÖ':'‚ùå';
    case 'url': return prop.url? `<a href="${prop.url}" target="_blank">üîó</a>`:'';
    case 'email': return prop.email || '';
    case 'formula': {
      const f=prop.formula; if(!f) return '';
      if (f.type==='number') return f.number!=null ? formatNumber(f.number) : '';
      if (f.type==='string') return f.string||'';
      if (f.type==='boolean') return f.boolean?'‚úÖ':'‚ùå';
      if (f.type==='date') return f.date ? new Date(f.date.start).toLocaleDateString('en-GB') : '';
      return '';
    }
    case 'rollup': {
      const r=prop.rollup; if(!r) return '';
      if (r.type==='number') return r.number!=null ? formatNumber(r.number) : '';
      if (r.type==='array') return r.array.map(it =>
        it.title?.map(t=>t.plain_text).join('') ||
        it.rich_text?.map(t=>t.plain_text).join('') ||
        (it.number!=null ? formatNumber(it.number) : '')
      ).filter(Boolean).join(', ');
      return '';
    }
    default: return '';
  }
}
function getPlainValue(prop){
  if (!prop) return '';
  switch(prop.type){
    case 'title': return prop.title.map(t=>t.plain_text).join(' ');
    case 'rich_text': return prop.rich_text.map(t=>t.plain_text).join(' ');
    case 'number': return (prop.number??'').toString();
    case 'select': return prop.select?.name || '';
    case 'multi_select': return prop.multi_select.map(t=>t.name).join(' ');
    case 'date': return prop.date?.start || '';
    case 'checkbox': return prop.checkbox?'true':'false';
    case 'email': return prop.email || '';
    case 'url': return prop.url || '';
    case 'formula': { const f=prop.formula; return f?.string || (f?.number?.toString()||'') || (f?.boolean?'true':'false') || f?.date?.start || ''; }
    case 'rollup': {
      const r=prop.rollup; if(!r) return '';
      if (r.type==='number') return (r.number??'').toString();
      if (r.type==='array')  return r.array.map(it => it.title?.map(t=>t.plain_text).join('') || it.rich_text?.map(t=>t.plain_text).join('') || (it.number?.toString()||'')).join(' ');
      return '';
    }
    default: return '';
  }
}
function getSortValue(prop){
  if (!prop) return '';
  if (prop.type==='number') return prop.number ?? -Infinity;
  if (prop.type==='date')   return prop.date ? new Date(prop.date.start).getTime() : 0;
  if (prop.type==='select') return (prop.select?.name || '').toLowerCase();
  if (prop.type==='title')  return prop.title.map(t=>t.plain_text).join('').toLowerCase();
  return getPlainValue(prop).toLowerCase();
}

  // ---- Helper: get a reliable vendor name for a record
function getVendorName(rec) {
  if (!rec || !rec.properties) return 'Unknown';

  // 1) Try common keys in order
  const candidates = ['Vendor1', 'Vendor', 'Vendor Name', 'Vendor/Label'];
  for (const key of candidates) {
    const p = rec.properties[key];
    if (p) {
      const txt =
        // relation resolved by backend?
        (p.relation_titles ? p.relation_titles :
        // title or rich_text or select etc.
        getPlainValue(p)).trim();
      if (txt) return txt;
    }
  }

  // 2) Try to find whichever property the backend mapped to display header "Vendor"
  try {
    const headers = currentData?.columnHeaders || {};
    const keyForVendor = Object.keys(headers).find(k => headers[k] === 'Vendor');
    if (keyForVendor) {
      const p = rec.properties[keyForVendor];
      const txt = (p?.relation_titles ? p.relation_titles : getPlainValue(p)).trim();
      if (txt) return txt;
    }
  } catch (e) {
    // ignore
  }

  // 3) Last resort: scan for the first property that looks like a vendor-ish text
  for (const [k, p] of Object.entries(rec.properties)) {
    const low = k.toLowerCase();
    if (low.includes('vendor')) {
      const txt = (p?.relation_titles ? p.relation_titles : getPlainValue(p)).trim();
      if (txt) return txt;
    }
  }

  return 'Unknown';
}

/* =================== SUMMARIES =================== */
function updateSummaryBoxes(){
  const rows = filteredData || currentData?.results || [];
  const totalBy={}, unpaidBy={};
  rows.forEach(r=>{
    if (!showVoidedItems && r.properties?.['VOID?']?.checkbox) return;
    const net = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? null;
    if (net==null) return;
    const rec = r.properties?.['Amount Received']?.number;
    const cur = r.properties?.['Currency (Inv/Stmt)']?.select?.name || r.properties?.['Currency']?.select?.name || 'Unknown';
    totalBy[cur]=(totalBy[cur]||0)+net;
    if (rec==null || rec===0) unpaidBy[cur]=(unpaidBy[cur]||0)+net;
  });
  const line = o => Object.entries(o).map(([c,a])=>`${c} ${formatNumber(a)}`).join(' | ') || '‚Äî';
  document.getElementById('totalIncome').textContent = line(totalBy);
  document.getElementById('unpaidIncome').textContent = line(unpaidBy);
}

/* =================== CHARTS =================== */
let chMonthly=null, chCurrency=null, chVendors=null, chType=null;

function ensureCharts(){
  if (!chMonthly){
    chMonthly = new ApexCharts(document.querySelector('#chartMonthly'), {
      chart:{ type:'area', height:'100%', toolbar:{show:false} },
      grid:{ strokeDashArray:3 },
      dataLabels:{ enabled:false },
      stroke:{ curve:'smooth', width:2 },
      fill:{ type:'gradient', gradient:{opacityFrom:.35, opacityTo:.05} },
      xaxis:{ categories:[], labels:{rotate:-45} },
      series:[{name:'Net', data:[]}],
      yaxis:{ labels:{ formatter:(v)=> Number(v).toLocaleString('en-GB') } },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
      colors:['#d29a12']
    }); chMonthly.render();
  }
  if (!chCurrency){
    chCurrency = new ApexCharts(document.querySelector('#chartCurrency'), {
      chart:{ type:'donut', height:'100%', toolbar:{show:false} },
      labels:[], series:[], legend:{ position:'bottom' },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } }
    }); chCurrency.render();
  }
  if (!chVendors){
    chVendors = new ApexCharts(document.querySelector('#chartVendors'), {
      chart:{ type:'bar', height:'100%', toolbar:{show:false} },
      plotOptions:{ bar:{ horizontal:true, borderRadius:4 } },
      dataLabels:{ enabled:false },
      xaxis:{ categories:[], labels:{ formatter:(v)=> Number(v).toLocaleString('en-GB') } },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
      series:[{ name:'Net', data:[] }],
      colors:['#d29a12']
    }); chVendors.render();
  }
  if (!chType){
    chType = new ApexCharts(document.querySelector('#chartType'), {
      chart:{ type:'donut', height:'100%', toolbar:{show:false} },
      labels:[], series:[], legend:{ position:'bottom' },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } }
    }); chType.render();
  }
}

function updateCharts(){
  ensureCharts();
  const rows = filteredData || currentData?.results || [];

  // Monthly
  const m = new Map();
  rows.forEach(r=>{
    const d = r.properties?.['Invoice date']?.date?.start;
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    if (!d || !n) return;
    const dt = new Date(d);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    m.set(key, (m.get(key)||0)+n);
  });
  const months = [...m.keys()].sort();
  const mVals  = months.map(k=>+m.get(k).toFixed(2));
  chMonthly.updateOptions({ xaxis:{ categories:months } }, false, true);
  chMonthly.updateSeries([{ name:'Net', data:mVals }]);

  // Currency (donut)
  const cMap = {};
  rows.forEach(r=>{
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    const c = r.properties?.['Currency (Inv/Stmt)']?.select?.name || r.properties?.['Currency']?.select?.name || 'Unknown';
    if (!n) return; cMap[c]=(cMap[c]||0)+n;
  });
  const cLabels = Object.keys(cMap);
  const cSeries = cLabels.map(k=>+cMap[k].toFixed(2));
  chCurrency.updateOptions({ labels:cLabels }, false, true);
  chCurrency.updateSeries(cSeries);

 // Vendors (horizontal bar) ‚Äì sum Net/Net Amount per resolved Vendor
const vTotals = {};
rows.forEach(r => {
  const net = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
  if (!net) return;
  const vendor = getVendorName(r) || 'Unknown';
  vTotals[vendor] = (vTotals[vendor] || 0) + net;
});

// If we only have "Unknown" and nothing else, keep it;
// otherwise drop pure "Unknown" bucket so real vendors show cleanly.
let vEntries = Object.entries(vTotals);
const nonUnknown = vEntries.filter(([name]) => name !== 'Unknown');
if (nonUnknown.length) vEntries = nonUnknown;

const top = vEntries.sort((a,b)=>b[1]-a[1]).slice(0, 10).reverse();
chVendors.updateOptions({
  xaxis: {
    categories: top.map(([name]) => name),
    labels: { formatter: (v) => Number(v).toLocaleString('en-GB') }
  }
}, false, true);
chVendors.updateSeries([{ name: 'Net', data: top.map(([,val]) => +val.toFixed(2)) }]);

  // Income by Type (donut)
  const tMap = {};
  rows.forEach(r=>{
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    const t = r.properties?.['Income Type']?.select?.name || 'Unknown';
    if (!n) return; tMap[t]=(tMap[t]||0)+n;
  });
  const tLabels = Object.keys(tMap);
  const tSeries = tLabels.map(k=>+tMap[k].toFixed(2));
  chType.updateOptions({ labels:tLabels }, false, true);
  chType.updateSeries(tSeries);

  resizeCharts();
}
function resizeCharts(){
  [chMonthly, chCurrency, chVendors, chType].forEach(ch=>{
    if (!ch) return;
    const el = ch.w.globals.dom.Paper.node.parentElement;
    const h  = el.clientHeight || 320;
    ch.updateOptions({ chart:{ height:h } }, false, true);
  });
}
new ResizeObserver(resizeCharts).observe(document.body);

/* =================== CSV =================== */
function csvEscape(s){ if (s==null) return '""'; return `"${String(s).replace(/\r?\n|\r/g,' ').replace(/"/g,'""')}"`; }
function exportCSV(){
  if (!currentData) return;
  const rows = filteredData || currentData.results || []; if (!rows.length) return;
  const order = currentData.columnOrder || [];
  let cols = []; if (order.length){ cols = order.filter(c=>rows.some(r=>r.properties[c])); }
  else{ const set=new Set(); rows.forEach(r=>Object.keys(r.properties||{}).forEach(k=>set.add(k))); cols=[...set]; }
  const headers = currentData.columnHeaders || {};
  const lines = [ cols.map(c=>csvEscape(headers[c]||c)).join(',') ];
  rows.forEach(r=>{
    const line = cols.map(c=>csvEscape(getPlainValue(r.properties?.[c]))).join(',');
    lines.push(line);
  });
  const csv = '\uFEFF' + lines.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); const client=(document.getElementById('clientDisplay').textContent||'data').replace(/\s+Dashboard$/,'').trim();
  a.href=url; a.download=`dashboard-${client}-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* =================== ERROR =================== */
function showError(msg){ document.getElementById('tableContent').innerHTML = `<div class="error">${msg}</div>`; }
</script>
</body>
</html>
