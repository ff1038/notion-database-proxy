<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Client Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
  :root{ --gap:16px; --radius:12px; }
  body{ font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; margin:0; background:#f6f7fb; color:#222; }

  /* Header */
  .dashboard-header{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:#fff;padding:6px 10px;margin:0 0 8px 0;
  }
  .secure-chip{display:flex;gap:6px;align-items:center;white-space:nowrap;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);font-size:13px;}
  .hdr-right{display:flex;align-items:center;gap:8px}
  .hdr-title{font-weight:700;font-size:14px}
  .hdr-menu{position:relative}
  .hdr-btn{
    display:flex;align-items:center;gap:6px;
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
    color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:13px;
  }
  .hdr-dd{position:absolute;right:0;top:110%;background:#fff;color:#1f2330;border:1px solid #e4e7ef;border-radius:10px;box-shadow:0 12px 30px rgba(31,35,48,.14);display:none;min-width:220px;overflow:hidden}
  .hdr-menu.open .hdr-dd{display:block}
  .hdr-dd a{display:block;padding:10px 12px;text-decoration:none;color:#1f2330;font-size:13px}
  .hdr-dd a:hover{background:#f6f7fb}
  .hdr-dd a.disabled{color:#9aa3b2;pointer-events:none;cursor:not-allowed;opacity:.6;}

  .page{padding:16px 20px 20px}

  /* Summary */
  .summary-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:12px;}
  .summary-box{background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-left:4px solid #667eea;}
  .summary-title{font-size:14px;color:#6c7583;font-weight:600;margin:0 0 8px}
  .summary-value{font-size:26px;font-weight:800;color:#1f2330}

  /* Toolbar */
  .toolbar{
    background:#fff;border-radius:12px;padding:12px 16px;margin-bottom:var(--gap);
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
  }
  .filter-btn{padding:6px 12px;border:1px solid #e0e3ea;border-radius:8px;background:#fff;font-size:12px;cursor:pointer}
  .filter-btn.active{background:#667eea;border-color:#667eea;color:#fff}
  .search-box{border:2px solid #e5e7f1;border-radius:8px;padding:8px 12px;font-size:14px;width:260px}
  .export-btn{background:#2fbf71;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer}
  .spacer{flex:1}
  #recordCount{color:#6e7587;font-size:14px}
  .tabs{display:flex;gap:10px;margin-left:6px}
  .tab-btn{background:#fff;border:1px solid #e0e3ea;border-radius:999px;padding:6px 14px;cursor:pointer}
  .tab-btn.active{background:#2f2e41;color:#fff;border-color:#2f2e41}

  /* Table */
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
  .table-wrapper{
    overscroll-behavior-x: contain;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y pinch-zoom; /* prevent swipe-to-back */
  }
 /* --- TABLE + HEADERS --- */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;         /* keeps a predictable grid */
  font-size:12px;
}

  /* Always box-size cells and allow wrapping inside headers */
th, td { box-sizing: border-box; overflow: visible !important; }
  
th{
  position:sticky; top:0;
  background:#f6f7fb;
  border-bottom:2px solid #e5e7f1;
  font-weight:600;
  padding:8px 12px;
  vertical-align:bottom;

  /* allow wrapping and prevent overflow into neighbors */
  white-space:normal;
  overflow-wrap:anywhere;     /* ✅ let long labels wrap cleanly */
  word-break:break-word;
  line-height:1.15;
}
td{
  border-bottom:1px solid #eef0f5;
  padding:12px;
  vertical-align:top;
}

/* --- COLUMN HELPERS (apply to *both* th and td) --- */

/* 1) Headers fully visible + fix overlap on Date / Inv# by giving them min width */
.col-date{ min-width: 12ch; }      /* Date (Inv/Stmt) */
.col-inv { min-width: 8ch;  }      /* Inv # */

/* 2) Narrow the Income Type column (let header/data wrap) */
.col-income-type{ width: 14ch; }   /* wraps by default */

/* Currency columns: allow header to wrap, but widen a touch so it's readable */
.col-currency {
  width: 10ch;                 /* was 7.5ch; gives header 2–3 lines comfortably */
  text-align: center;
  white-space: nowrap;         /* data stays 3-letter tag on one line */
}

/* 4) Numbers: never wrap + right-aligned + a safe min-width */
.num-col{
  white-space:nowrap;              /* ✅ never wrap numbers */
  text-align:right;
  min-width: 9ch;                  /* prevents forced wrapping in fixed layout */
  font-variant-numeric: tabular-nums;
}

/* Vendor + Description: give room so they never overlap */
.col-vendor { min-width: 18ch; }

/* Optional: a reasonable description width that can wrap nicely */
.col-desc   { width: 32ch; overflow-wrap:anywhere; hyphens:auto; }

  /* Pills can wrap normally */
  .tag{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-block;white-space:normal}
  .tag.blue{background:#e6f0ff;color:#1e5bd9}
  .tag.green{background:#e9f7ef;color:#1f7a43}
  .tag.purple{background:#eee9ff;color:#5c3fd6}
  .tag.orange{background:#fff2e6;color:#c76506}
  .tag.pink{background:#fde6f1;color:#bf2066}
  .tag.yellow{background:#fff8d6;color:#8c6d00}
  .tag.gray{background:#ecf0f3;color:#54616d}
  .tag.gold{background:#fff4d6;color:#a37500}

  /* Multi-select dropdown */
  .msel{position:relative}
  .msel-btn{
    display:flex;align-items:center;gap:6px;
    border:1px solid #e0e3ea;background:#fff;border-radius:8px;
    padding:6px 10px;font-size:12px;cursor:pointer
  }
  .msel-panel{
    position:absolute;top:110%;left:0;z-index:20;background:#fff;border:1px solid #e0e3ea;border-radius:10px;
    width:280px;box-shadow:0 12px 30px rgba(24,27,51,.12);padding:8px;display:none;
  }
  .msel.open .msel-panel{display:block}
  .msel-list{max-height:220px;overflow:auto;padding-right:4px}
  .msel-item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:6px;cursor:pointer;white-space:nowrap;}
  .msel-item:hover{background:#f6f7fb}
  .msel-footer{display:flex;justify-content:space-between;gap:8px;margin-top:8px}
  .msel-apply,.msel-clear{flex:1;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
  .msel-apply{background:#667eea;color:#fff}
  .msel-clear{background:#f1f2f8}

  /* Tax year dropdown */
  .filter-select{
    border:1px solid #e0e3ea;background:#fff;border-radius:8px;
    padding:3px 5px;font-size:12px;height:34px;
  }

  @media (max-width:1024px){
    .summary-row{grid-template-columns:1fr}
    .charts-grid{grid-template-columns:1fr}
    .table-wrapper{max-height:none}
  }
  
  /* Charts */
  .charts-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)}
  .chart-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px 12px 6px;display:flex;flex-direction:column;min-height:330px}
  .chart-title{font-weight:700;margin:4px 8px 6px}
  .chart-wrap{flex:1;min-height:280px}

  .loading{padding:60px;text-align:center;color:#6e7587}
  .error{padding:40px;margin:20px;background:#fde9ec;border:1px solid #f7c9d1;border-radius:12px;color:#8d2a3b;text-align:center}
</style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header">
    <div class="secure-chip">
      <span>🔒 Secure access</span><span>•</span>
      <span>User: <span id="userEmail">Loading...</span></span>
    </div>

    <div class="hdr-right">
      <div class="hdr-title"><span id="clientDisplay">Linden Jay Dashboard</span></div>
      <div class="hdr-menu" id="hdrMenu">
        <button class="hdr-btn" type="button" onclick="document.getElementById('hdrMenu').classList.toggle('open')">
          Open
          <span>▾</span>
        </button>
        <div class="hdr-dd" onclick="document.getElementById('hdrMenu').classList.remove('open')">
  <a href="#" id="linkFinance">Finance Dashboard</a>
  <a href="#" id="linkAgreement" class="disabled" aria-disabled="true" title="Coming soon">Agreement Tracker</a>
  <a href="#" id="linkRoyalty" class="disabled" aria-disabled="true" title="Coming soon">Royalty Tracker</a>
</div>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-title">Total Income by Currency</div>
        <div class="summary-value" id="totalIncome">—</div>
      </div>
      <div class="summary-box" style="border-left-color:#4b91f1">
        <div class="summary-title">Unpaid Income by Currency</div>
        <div class="summary-value" id="unpaidIncome">—</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
      <button class="filter-btn active" onclick="applyDateFilter('all',event)">All Time</button>
      <button class="filter-btn" onclick="applyDateFilter('30',event)">Last 30 Days</button>
      <button class="filter-btn" onclick="applyDateFilter('90',event)">Last 90 Days</button>
      <button class="filter-btn" onclick="applyDateFilter('180',event)">Last 6 Months</button>
      <button class="filter-btn" onclick="applyDateFilter('365',event)">Last 12 Months</button>
      <button class="filter-btn" onclick="applyDateFilter('2025',event)">2025</button>
      <button class="filter-btn" onclick="applyDateFilter('2024',event)">2024</button>
      <button class="filter-btn" onclick="applyDateFilter('2023',event)">2023</button>
      <button class="filter-btn" onclick="applyDateFilter('2022',event)">2022</button>
      <button class="filter-btn" onclick="applyDateFilter('2021',event)">2021</button>

      <button class="filter-btn" id="unpaidBtn" onclick="applyUnpaidFilter()">Unpaid Income</button>
      <button class="filter-btn" id="voidBtn" onclick="toggleVoidFilter()">Show Voided</button>

      <!-- (optional) custom multis -->
      <div class="msel" id="msIncomeType"></div>
      <div class="msel" id="msCurrency"></div>
                <select id="ukTaxYearSelect" class="filter-select" aria-label="UK tax year">
  <option value="">Tax Year</option>
  <option value="2025">UK TY 2025/26</option>
  <option value="2024">UK TY 2024/25</option>
  <option value="2023">UK TY 2023/24</option>
  <option value="2022">UK TY 2022/23</option>
</select>

      <div class="spacer"></div>

      <input type="text" class="search-box" id="searchBox" placeholder="Search data…" />
      <button class="export-btn" onclick="exportCSV()">⬇ Export CSV</button>
      <span id="recordCount"></span>

      <!-- Tabs moved here -->
      <div class="tabs">
        <button class="tab-btn active" id="tabTable"  onclick="switchTab('table')">📊 Table</button>
        <button class="tab-btn" id="tabCharts" onclick="switchTab('charts')">📈 Charts</button>
      </div>      
    </div>
    


    <!-- Charts -->
    <section id="chartsSection" style="display:none">
      <div class="charts-grid">
        <div class="chart-card"><div class="chart-title">Monthly Income Trends</div><div class="chart-wrap" id="chartMonthly"></div></div>
        <div class="chart-card"><div class="chart-title">Income by Currency</div><div class="chart-wrap" id="chartCurrency"></div></div>
        <div class="chart-card"><div class="chart-title">Top Vendors by Income</div><div class="chart-wrap" id="chartVendors"></div></div>
        <div class="chart-card"><div class="chart-title">Income by Type</div><div class="chart-wrap" id="chartType"></div></div>
      </div>
    </section>

    <!-- Table -->
    <section id="tableSection">
      <div class="card">
        <div id="tableContent"><div class="loading">Loading your data…</div></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid #eef0f5">
          <div id="paginationInfo" style="color:#6e7587"></div>
          <div>
            <button class="filter-btn" onclick="changePage(-1)" id="prevBtn">← Prev</button>
            <span id="pageNumbers"></span>
            <button class="filter-btn" onclick="changePage(1)" id="nextBtn">Next →</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Refresh FAB -->
  <button title="Refresh" onclick="loadData()" style="position:fixed;right:24px;bottom:24px;background:#667eea;color:#fff;border:none;width:56px;height:56px;border-radius:50%;box-shadow:0 10px 30px rgba(102,126,234,.35);font-size:20px;cursor:pointer">↻</button>

<script>
/* =================== STATE =================== */
let currentUserEmail = '';
let currentData = null;
let filteredData = null;
let sortOrder = {};
let currentPage = 1;
let recordsPerPage = 50;
let currentDateFilter = 'all';
let isUnpaidFilter = false;
let showVoidedItems = false;

const selectedIncomeTypes = new Set();
const selectedCurrencies  = new Set();

/* =================== TABS =================== */
function switchTab(which){
  const tTable  = document.getElementById('tabTable');
  const tCharts = document.getElementById('tabCharts');
  const sTable  = document.getElementById('tableSection');
  const sCharts = document.getElementById('chartsSection');
  if (which==='charts'){
    tCharts.classList.add('active'); tTable.classList.remove('active');
    sCharts.style.display=''; sTable.style.display='none';
    setTimeout(resizeCharts, 40);
  }else{
    tTable.classList.add('active'); tCharts.classList.remove('active');
    sTable.style.display=''; sCharts.style.display='none';
  }
}

/* =================== FILTER BUTTONS =================== */
function applyDateFilter(filter, evt){
  // clear UK TY selection when using generic date filters
  clearUKTaxYearSelection();

  document.querySelectorAll('.toolbar .filter-btn').forEach(b=>{ if(!b.id) b.classList.remove('active'); });
  if (evt && evt.target) evt.target.classList.add('active');
  currentDateFilter = filter;
  isUnpaidFilter = false; document.getElementById('unpaidBtn').classList.remove('active');
  applyFilters();
}
  
function applyUnpaidFilter(){
  isUnpaidFilter = !isUnpaidFilter;
  document.getElementById('unpaidBtn').classList.toggle('active',isUnpaidFilter);
  if (isUnpaidFilter){
    currentDateFilter='all';
    document.querySelectorAll('.toolbar .filter-btn').forEach(b=>{ if(!b.id) b.classList.remove('active'); });
  }
  applyFilters();
}
function toggleVoidFilter(){
  showVoidedItems = !showVoidedItems;
  const btn = document.getElementById('voidBtn');
  btn.textContent = showVoidedItems ? 'Hide Voided' : 'Show Voided';
  btn.classList.toggle('active',showVoidedItems);
  applyFilters();
}

// =================== MULTI-SELECT UI ===================
function makeMultiSelect(el, {label, options, selectedSet, onApply}){
  el.innerHTML = `
    <button class="msel-btn" type="button"><span>${label}</span><span class="msel-count"></span>▾</button>
    <div class="msel-panel">
      <div class="msel-list"></div>
      <div class="msel-footer">
        <button class="msel-clear" type="button">Clear</button>
        <button class="msel-apply" type="button">Apply</button>
      </div>
    </div>
  `;

  const btn    = el.querySelector('.msel-btn');
  const panel  = el.querySelector('.msel-panel');
  const list   = el.querySelector('.msel-list');
  const applyB = el.querySelector('.msel-apply');
  const clearB = el.querySelector('.msel-clear');
  const count  = el.querySelector('.msel-count');

  function updateCount(){ count.textContent = selectedSet.size ? `(${selectedSet.size})` : ''; }

  function setOpen(isOpen){ panel.style.display = isOpen ? 'block' : 'none'; el.classList.toggle('open', isOpen); }

  function renderList(){
    list.innerHTML='';
    options.forEach(o=>{
      const id = `${label}-${o}`.replace(/\s+/g,'_');
      const row = document.createElement('label');
      row.className='msel-item';
      row.innerHTML = `<input type="checkbox" id="${id}" ${selectedSet.has(o)?'checked':''}/> <span>${o}</span>`;
      const input = row.querySelector('input');

      // click anywhere on the row to toggle
      row.addEventListener('click', (e)=>{
        if (e.target !== input) input.checked = !input.checked;
        input.dispatchEvent(new Event('change'));
      });

      // auto-apply when a checkbox changes
      input.addEventListener('change', ()=>{
        if (input.checked) selectedSet.add(o); else selectedSet.delete(o);
        updateCount();
        // small debounce so multiple checks don't re-render too often
        clearTimeout(row._t); row._t = setTimeout(()=> onApply && onApply(), 120);
      });

      list.appendChild(row);
    });
  }

  btn.addEventListener('click', ()=>{
    const open = !el.classList.contains('open');
    setOpen(open);
    if (open) { renderList(); updateCount(); }
  });

  clearB.addEventListener('click', ()=>{
    selectedSet.clear(); renderList(); updateCount();
    onApply && onApply();
  });

  applyB.addEventListener('click', ()=>{
    setOpen(false);
    onApply && onApply();
  });

  // close on outside click
  document.addEventListener('click', (e)=>{ if (!el.contains(e.target)) setOpen(false); });

  // first render
  renderList(); updateCount();
}
  
/* =================== SEARCH =================== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('searchBox').addEventListener('input', applyFilters);
});

/* =================== DATA LOAD =================== */
window.addEventListener('load', ()=>{
  const url = new URLSearchParams(location.search);
  const email = url.get('userEmail'); const key = url.get('secureKey'); const ts = url.get('timestamp');
  if (!email){ showError('No user specified.'); return; }
  currentUserEmail = email; document.getElementById('userEmail').textContent=email;
  loadData(email,key,ts);
});

async function loadData(userEmail, secureKey, timestamp){
  const tableContent = document.getElementById('tableContent');
  tableContent.innerHTML = '<div class="loading">Verifying access and loading your data…</div>';
  try{
    const apiUrl = `/api/client-data?userEmail=${encodeURIComponent(userEmail)}&secureKey=${secureKey}&timestamp=${timestamp}`;
    const resp = await fetch(apiUrl, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    if (!resp.ok){
      let msg=`Access denied: ${resp.status}`; try{ const e=await resp.json(); msg=e.error||msg; }catch{}
      throw new Error(msg);
    }
    const data = await resp.json();
    const cd = document.getElementById('clientDisplay');
    if (data.authorizedClient && cd) cd.textContent = `${data.authorizedClient} Dashboard`;
    currentData = data;

    makeMultiSelect(document.getElementById('msIncomeType'),{
      label:'Income Types',
      options:[...(data.metadata?.incomeTypes || [])],
      selectedSet:selectedIncomeTypes,
      onApply:applyFilters
    });
    makeMultiSelect(document.getElementById('msCurrency'),{
      label:'Currencies',
      options:[...(data.metadata?.currencies || [])],
      selectedSet:selectedCurrencies,
      onApply:applyFilters
    });

    applyFilters();
    switchTab('table');
  }catch(e){ console.error(e); showError(`Access Denied: ${e.message}`); }
}

  /* ===== UK Tax Year (dropdown) ===== */
let currentUKTaxYear = null; // number (start year) or null

function getUKTaxYearRange(year) {
  // 6 Apr (year) 00:00:00.000 → 5 Apr (year+1) 23:59:59.999
  const start = new Date(year, 3, 6, 0, 0, 0, 0);          // Apr is month 3
  const end   = new Date(year + 1, 3, 5, 23, 59, 59, 999);
  return { start, end };
}

function getColClass(col){
  switch (col) {
    case 'Invoice date':                 return 'col-date col-nowrap';
    case 'Inv #':                        return 'col-inv col-nowrap';
    case 'Vendor':                        return 'col-vendor';      
    case 'Description':                  return 'col-desc';
    case 'Income Type':                  return 'col-income-type';
    case 'Currency (Inv/Stmt)':
    case 'Currency (receipt)':
    case 'Currency':                     return 'col-currency';
    case 'Net':
    case 'Gross':
    case 'Amount Received':
    case 'Adjustments':
    case 'Net Commissionable':
    case 'Mgmt Commission':
    case 'Mgmt Inv #':
    case 'Commission %':                 return 'num-col';
    default:                             return '';
  }
}

// Attach the dropdown listener once DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  const ukSel = document.getElementById('ukTaxYearSelect');
  if (!ukSel) return;
  ukSel.addEventListener('change', (e) => {
    const v = e.target.value;
    currentUKTaxYear = v ? Number(v) : null;

    if (currentUKTaxYear !== null) {
      // Clear "active" styles on generic date range buttons
      document.querySelectorAll('.toolbar .filter-btn').forEach(b => {
        if (!b.id) b.classList.remove('active');
      });
      // Make sure we don't also apply the generic date filter
      currentDateFilter = 'all';
    }
    applyFilters();
  });
});

// When user clicks any of your normal date filters, clear the UK tax year selection
function clearUKTaxYearSelection() {
  currentUKTaxYear = null;
  const ukSel = document.getElementById('ukTaxYearSelect');
  if (ukSel) ukSel.value = '';
}

/* =================== FILTER / REDUCE =================== */
function applyFilters(){
  if (!currentData) return;
  let rows = [...(currentData.results || [])];

  if (!showVoidedItems){
    rows = rows.filter(r => !(r.properties?.['VOID?']?.checkbox === true));
  }

  if (selectedIncomeTypes.size){
    rows = rows.filter(r=>{
      const t = r.properties?.['Income Type']?.select?.name;
      return t && selectedIncomeTypes.has(t);
    });
  }

  if (selectedCurrencies.size){
    rows = rows.filter(r=>{
      const c = r.properties?.['Currency (Inv/Stmt)']?.select?.name
             || r.properties?.['Currency']?.select?.name;
      return c && selectedCurrencies.has(c);
    });
  }

  // 📌 Date filtering logic
  if (currentUKTaxYear !== null) {
    // If UK tax year dropdown is selected → take precedence
    const { start, end } = getUKTaxYearRange(currentUKTaxYear);
    rows = rows.filter(r => {
      const d = r.properties?.['Invoice date']?.date?.start;
      if (!d) return false;
      const rec = new Date(d);
      return rec >= start && rec <= end;
    });
  } else if (currentDateFilter !== 'all') {
    // Otherwise fall back to existing date filter buttons
    rows = rows.filter(r=>{
      const d = r.properties?.['Invoice date']?.date?.start;
      if (!d) return false;
      const rec = new Date(d); 
      const now = new Date();
      if (['30','90','180','365'].includes(currentDateFilter)){
        const days = +currentDateFilter;
        return rec >= new Date(now.getTime() - days*24*3600*1000);
      } else {
        return rec.getFullYear().toString() === currentDateFilter;
      }
    });
  }

  if (isUnpaidFilter){
    rows = rows.filter(r=>{
      const n = r.properties?.['Amount Received']?.number;
      return n==null || n===0;
    });
  }

  const q = (document.getElementById('searchBox').value || '').toLowerCase().trim();
  if (q){
    rows = rows.filter(rec=>{
      let s='';
      Object.values(rec.properties||{}).forEach(p => s += ' ' + getPlainValue(p));
      return s.toLowerCase().includes(q);
    });
  }

  filteredData = rows;

  currentPage = 1;
  displayTable(currentData);
  updateSummaryBoxes();
  updateCharts();
}
/* =================== TABLE =================== */
function displayTable(data){
  const tableContent = document.getElementById('tableContent');
  const rows = filteredData || data.results || [];
  if (!rows.length){
    tableContent.innerHTML = '<div class="loading">No data found.</div>';
    document.getElementById('paginationInfo').textContent='';
    document.getElementById('recordCount').textContent='0 records';
    return;
  }
  const order = data.columnOrder || [];
  let props = [];
  if (order.length){ props = order.filter(c => rows.some(r=>r.properties[c])); }
  else{
    const set=new Set(); rows.forEach(r=>Object.keys(r.properties||{}).forEach(k=>{if(k!=='Client') set.add(k)}));
    props=[...set];
  }

  const totalRecords = rows.length;
  const totalPages = Math.ceil(totalRecords/recordsPerPage);
  const startIndex = (currentPage-1)*recordsPerPage;
  const endIndex = Math.min(startIndex+recordsPerPage,totalRecords);
  const pageData = rows.slice(startIndex,endIndex);

  const headers = data.columnHeaders || {};
let html = '<div class="table-wrapper"><table><thead><tr>';
props.forEach(p=>{
  const cls = getColClass(p);
  html += `<th class="${cls}" data-column="${p}" onclick="sortTable('${p}')">${headers[p]||p}</th>`;
});
html += '</tr></thead><tbody>';

pageData.forEach(rec=>{
  const isVoided = rec.properties?.['VOID?']?.checkbox === true;
  html += `<tr${isVoided?' style="opacity:.6;text-decoration:line-through;background:#fafbff"':''}>`;
  props.forEach(p=>{
    const cls = getColClass(p);
    html += `<td class="${cls}">${getDisplayValue(rec.properties?.[p], p)}</td>`;
  });
  html += '</tr>';
});

  html += '</tbody></table></div>';
  tableContent.innerHTML = html;

  document.getElementById('paginationInfo').textContent = `Showing ${startIndex+1}-${endIndex} of ${totalRecords}`;
  document.getElementById('recordCount').textContent    = `${totalRecords} record${totalRecords!==1?'s':''}`;
  buildPageButtons(totalPages);
}

function sortTable(column){
  const rows = filteredData || currentData.results || [];
  const now  = (sortOrder[column] === 'asc') ? 'desc' : 'asc';
  sortOrder = {[column]:now};
  rows.sort((a,b)=>{
    const av = getSortValue(a.properties?.[column]);
    const bv = getSortValue(b.properties?.[column]);
    if (av===bv) return 0; const cmp = av<bv? -1:1; return now==='asc'? cmp : -cmp;
  });
  currentPage=1; displayTable(currentData);
}
function buildPageButtons(total){
  const cont=document.getElementById('pageNumbers'); cont.innerHTML='';
  const show=Math.min(total,7); let start=Math.max(1,currentPage-Math.floor(show/2)); let end=Math.min(total,start+show-1);
  if (end-start<show-1) start=Math.max(1,end-show+1);
  for (let i=start;i<=end;i++){
    const b=document.createElement('button'); b.className='filter-btn'+(i===currentPage?' active':''); b.textContent=i;
    b.onclick=()=>{currentPage=i;displayTable(currentData);}; cont.appendChild(b);
  }
  document.getElementById('prevBtn').disabled=currentPage===1;
  document.getElementById('nextBtn').disabled=currentPage===total || total===0;
}
function changePage(delta){
  const total = Math.ceil((filteredData||[]).length/recordsPerPage);
  const np = currentPage+delta; if (np>=1 && np<=total){ currentPage=np; displayTable(currentData); }
}

/* =================== VALUE HELPERS =================== */
function formatNumber(n){ return Number(n||0).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function tagClassByName(name, column){
  const n=(name||'').toLowerCase();
  if (column==='Income Type'){
    if (n.includes('publishing')) return 'green';
    if (n.includes('master'))     return 'orange';
    if (n.includes('royalties'))  return 'blue';
    if (n.includes('other'))      return 'gray';
    return 'purple';
  }
  if (column.startsWith('Currency')){
    if (n==='gbp') return 'gold';
    if (n==='usd') return 'blue';
    if (n==='eur') return 'purple';
    return 'gray';
  }
  return 'gray';
}
function getDisplayValue(prop, columnName){
  if (!prop) return '';
  if (columnName==='Commission %' && prop.type==='number') return (Number(prop.number||0)*100).toFixed(2)+'%';
  switch(prop.type){
    case 'title': return prop.title.map(t=>t.plain_text).join('');
    case 'rich_text': return prop.rich_text.map(t=>t.plain_text).join('');
    case 'number': return prop.number!=null ? formatNumber(prop.number) : '';
    case 'select': {
      if (!prop.select) return '';
      const klass = tagClassByName(prop.select.name, columnName);
      return `<span class="tag ${klass}">${prop.select.name}</span>`;
    }
    case 'multi_select': return prop.multi_select.map(t=>`<span class="tag ${tagClassByName(t.name,columnName)}">${t.name}</span>`).join(' ');
    case 'date': return prop.date ? new Date(prop.date.start).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '';
    case 'checkbox': return prop.checkbox?'✅':'❌';
    case 'url': return prop.url? `<a href="${prop.url}" target="_blank">🔗</a>`:'';
    case 'email': return prop.email || '';
    case 'formula': {
      const f=prop.formula; if(!f) return '';
      if (f.type==='number') return f.number!=null ? formatNumber(f.number) : '';
      if (f.type==='string') return f.string||'';
      if (f.type==='boolean') return f.boolean?'✅':'❌';
      if (f.type==='date') return f.date ? new Date(f.date.start).toLocaleDateString('en-GB') : '';
      return '';
    }
    case 'rollup': {
      const r=prop.rollup; if(!r) return '';
      if (r.type==='number') return r.number!=null ? formatNumber(r.number) : '';
      if (r.type==='array') return r.array.map(it =>
        it.title?.map(t=>t.plain_text).join('') ||
        it.rich_text?.map(t=>t.plain_text).join('') ||
        (it.number!=null ? formatNumber(it.number) : '')
      ).filter(Boolean).join(', ');
      return '';
    }
    default: return '';
  }
}
function getPlainValue(prop){
  if (!prop) return '';
  switch(prop.type){
    case 'title': return prop.title.map(t=>t.plain_text).join(' ');
    case 'rich_text': return prop.rich_text.map(t=>t.plain_text).join(' ');
    case 'number': return (prop.number??'').toString();
    case 'select': return prop.select?.name || '';
    case 'multi_select': return prop.multi_select.map(t=>t.name).join(' ');
    case 'date': return prop.date?.start || '';
    case 'checkbox': return prop.checkbox?'true':'false';
    case 'email': return prop.email || '';
    case 'url': return prop.url || '';
    case 'formula': { const f=prop.formula; return f?.string || (f?.number?.toString()||'') || (f?.boolean?'true':'false') || f?.date?.start || ''; }
    case 'rollup': {
      const r=prop.rollup; if(!r) return '';
      if (r.type==='number') return (r.number??'').toString();
      if (r.type==='array')  return r.array.map(it => it.title?.map(t=>t.plain_text).join('') || it.rich_text?.map(t=>t.plain_text).join('') || (it.number?.toString()||'')).join(' ');
      return '';
    }
    default: return '';
  }
}
function getSortValue(prop){
  if (!prop) return '';
  if (prop.type==='number') return prop.number ?? -Infinity;
  if (prop.type==='date')   return prop.date ? new Date(prop.date.start).getTime() : 0;
  if (prop.type==='select') return (prop.select?.name || '').toLowerCase();
  if (prop.type==='title')  return prop.title.map(t=>t.plain_text).join('').toLowerCase();
  return getPlainValue(prop).toLowerCase();
}

  /* =================== SUMMARIES =================== */
function updateSummaryBoxes(){
  const rows = filteredData || currentData?.results || [];
  const totalBy = {};
  const unpaidBy = {};

  rows.forEach(r => {
    // skip voided unless toggled on
    if (!showVoidedItems && r.properties?.['VOID?']?.checkbox) return;

    // prefer “Net” then “Net Amount”
    const net =
      r.properties?.['Net']?.number ??
      r.properties?.['Net Amount']?.number ??
      null;

    if (net == null) return;

    // unpaid if Amount Received is null or 0
    const received = r.properties?.['Amount Received']?.number;

    // currency (prefer invoice/statement currency)
    const cur =
      r.properties?.['Currency (Inv/Stmt)']?.select?.name ||
      r.properties?.['Currency']?.select?.name ||
      'Unknown';

    totalBy[cur] = (totalBy[cur] || 0) + net;
    if (received == null || received === 0) {
      unpaidBy[cur] = (unpaidBy[cur] || 0) + net;
    }
  });

  const fmt = (n) => Number(n || 0).toLocaleString('en-GB', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  const line = (obj) =>
    Object.entries(obj)
      .map(([c, a]) => `${c} ${fmt(a)}`)
      .join(' • ') || '—';

  const totalEl  = document.getElementById('totalIncome');
  const unpaidEl = document.getElementById('unpaidIncome');
  if (totalEl)  totalEl.textContent  = line(totalBy);
  if (unpaidEl) unpaidEl.textContent = line(unpaidBy);
}

  /* ---------- Helper: get a reliable vendor name for a record ---------- */
function getVendorName(rec) {
  if (!rec || !rec.properties) return 'Unknown';

  // 1) Try common keys in order
  const candidates = ['Vendor1', 'Vendor', 'Vendor Name', 'Vendor/Label'];
  for (const key of candidates) {
    const p = rec.properties[key];
    if (p) {
      const txt = (p.relation_titles ? p.relation_titles : getPlainValue(p)).trim();
      if (txt) return txt;
    }
  }

  // 2) Try the property whose header the backend mapped to "Vendor"
  try {
    const headers = currentData?.columnHeaders || {};
    const keyForVendor = Object.keys(headers).find(k => headers[k] === 'Vendor');
    if (keyForVendor) {
      const p = rec.properties[keyForVendor];
      const txt = (p?.relation_titles ? p.relation_titles : getPlainValue(p)).trim();
      if (txt) return txt;
    }
  } catch (_) {}

  // 3) Last resort: any property name containing "vendor"
  for (const [k, p] of Object.entries(rec.properties)) {
    if (k.toLowerCase().includes('vendor')) {
      const txt = (p?.relation_titles ? p.relation_titles : getPlainValue(p)).trim();
      if (txt) return txt;
    }
  }

  return 'Unknown';
}
/* =================== CHARTS (unchanged core) =================== */
let chMonthly=null, chCurrency=null, chVendors=null, chType=null;
function ensureCharts(){
  if (!chMonthly){
    chMonthly = new ApexCharts(document.querySelector('#chartMonthly'), {
      chart:{ type:'area', height:'100%', toolbar:{show:false} },
      grid:{ strokeDashArray:3 }, dataLabels:{ enabled:false },
      stroke:{ curve:'smooth', width:2 },
      fill:{ type:'gradient', gradient:{opacityFrom:.35, opacityTo:.05} },
      xaxis:{ categories:[], labels:{rotate:-45} },
      series:[{name:'Net', data:[]}],
      yaxis:{ labels:{ formatter:(v)=> Number(v).toLocaleString('en-GB') } },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
      colors:['#d29a12']
    }); chMonthly.render();
  }
  if (!chCurrency){
    chCurrency = new ApexCharts(document.querySelector('#chartCurrency'), {
      chart:{ type:'donut', height:'100%', toolbar:{show:false} },
      labels:[], series:[], legend:{ position:'bottom' },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } }
    }); chCurrency.render();
  }
  if (!chVendors){
    chVendors = new ApexCharts(document.querySelector('#chartVendors'), {
      chart:{ type:'bar', height:'100%', toolbar:{show:false} },
      plotOptions:{ bar:{ horizontal:true, borderRadius:4 } },
      dataLabels:{ enabled:false },
      xaxis:{ categories:[], labels:{ formatter:(v)=> Number(v).toLocaleString('en-GB') } },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
      series:[{ name:'Net', data:[] }],
      colors:['#d29a12']
    }); chVendors.render();
  }
  if (!chType){
    chType = new ApexCharts(document.querySelector('#chartType'), {
      chart:{ type:'donut', height:'100%', toolbar:{show:false} },
      labels:[], series:[], legend:{ position:'bottom' },
      tooltip:{ y:{ formatter:(v)=> Number(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}) } }
    }); chType.render();
  }
}
function updateCharts(){
  ensureCharts();
  const rows = filteredData || currentData?.results || [];

  const m = new Map();
  rows.forEach(r=>{
    const d = r.properties?.['Invoice date']?.date?.start;
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    if (!d || !n) return;
    const dt = new Date(d);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    m.set(key, (m.get(key)||0)+n);
  });
  const months = [...m.keys()].sort();
  const mVals  = months.map(k=>+m.get(k).toFixed(2));
  chMonthly.updateOptions({ xaxis:{ categories:months } }, false, true);
  chMonthly.updateSeries([{ name:'Net', data:mVals }]);

  const cMap = {};
  rows.forEach(r=>{
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    const c = r.properties?.['Currency (Inv/Stmt)']?.select?.name || r.properties?.['Currency']?.select?.name || 'Unknown';
    if (!n) return; cMap[c]=(cMap[c]||0)+n;
  });
  const cLabels = Object.keys(cMap);
  const cSeries = cLabels.map(k=>+cMap[k].toFixed(2));
  chCurrency.updateOptions({ labels:cLabels }, false, true);
  chCurrency.updateSeries(cSeries);

  const vTotals = {};
  rows.forEach(r => {
    const net = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    if (!net) return;
    const vendor = getVendorName(r) || 'Unknown';
    vTotals[vendor] = (vTotals[vendor] || 0) + net;
  });
  let vEntries = Object.entries(vTotals);
  const nonUnknown = vEntries.filter(([name]) => name !== 'Unknown');
  if (nonUnknown.length) vEntries = nonUnknown;
  const top = vEntries.sort((a,b)=>b[1]-a[1]).slice(0, 10).reverse();
  chVendors.updateOptions({
    xaxis: { categories: top.map(([name]) => name),
      labels: { formatter: (v) => Number(v).toLocaleString('en-GB') } }
  }, false, true);
  chVendors.updateSeries([{ name: 'Net', data: top.map(([,val]) => +val.toFixed(2)) }]);

  const tMap = {};
  rows.forEach(r=>{
    const n = r.properties?.['Net']?.number ?? r.properties?.['Net Amount']?.number ?? 0;
    const t = r.properties?.['Income Type']?.select?.name || 'Unknown';
    if (!n) return; tMap[t]=(tMap[t]||0)+n;
  });
  const tLabels = Object.keys(tMap);
  const tSeries = tLabels.map(k=>+tMap[k].toFixed(2));
  chType.updateOptions({ labels:tLabels }, false, true);
  chType.updateSeries(tSeries);

  resizeCharts();
}
function resizeCharts(){
  [chMonthly, chCurrency, chVendors, chType].forEach(ch=>{
    if (!ch) return;
    const el = ch.w.globals.dom.Paper.node.parentElement;
    const h  = el.clientHeight || 320;
    ch.updateOptions({ chart:{ height:h } }, false, true);
  });
}
new ResizeObserver(resizeCharts).observe(document.body);

/* =================== CSV =================== */
function csvEscape(s){ if (s==null) return '""'; return `"${String(s).replace(/\r?\n|\r/g,' ').replace(/"/g,'""')}"`; }
function exportCSV(){
  if (!currentData) return;
  const rows = filteredData || currentData.results || []; if (!rows.length) return;
  const order = currentData.columnOrder || [];
  let cols = []; if (order.length){ cols = order.filter(c=>rows.some(r=>r.properties[c])); }
  else{ const set=new Set(); rows.forEach(r=>Object.keys(r.properties||{}).forEach(k=>set.add(k))); cols=[...set]; }
  const headers = currentData.columnHeaders || {};
  const lines = [ cols.map(c=>csvEscape(headers[c]||c)).join(',') ];
  rows.forEach(r=>{
    const line = cols.map(c=>csvEscape(getPlainValue(r.properties?.[c]))).join(',');
    lines.push(line);
  });
  const csv = '\uFEFF' + lines.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); const client=(document.getElementById('clientDisplay').textContent||'data').replace(/\s+Dashboard$/,'').trim();
  a.href=url; a.download=`dashboard-${client}-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* =================== ERROR =================== */
function showError(msg){ document.getElementById('tableContent').innerHTML = `<div class="error">${msg}</div>`; }

/* Close header dropdown on outside click */
document.addEventListener('click',(e)=>{
  const m=document.getElementById('hdrMenu');
  if (m && !m.contains(e.target)) m.classList.remove('open');
});
</script>
</body>
</html>
