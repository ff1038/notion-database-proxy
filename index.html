<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Dashboard</title>

  <style>
    /* -------- Base / layout -------- */
    :root { --brand:#667eea; --brand2:#764ba2; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background-color: #f8f9fa;
      color:#222;
    }

    .dashboard-header.merged{
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(135deg,var(--brand) 0%,var(--brand2) 100%);
      color:#fff; padding:18px 22px;
      border-radius:0; margin:0 0 16px 0; width:100%;
      overflow:hidden;
    }
    .page { padding: 20px; }
    .header-left .client-name{ margin:0; font-size:22px; font-weight:600; }
    .header-left .dashboard-subtitle{ margin:4px 0 0; font-size:13px; opacity:.9; }
    .secure-chip{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.25);
      padding:8px 12px; border-radius:10px; font-size:13px; white-space:nowrap;
      max-width: 100%;
    }
    .secure-chip .divider{ opacity:.6 }

    @media (max-width:768px){
      .dashboard-header.merged{flex-direction:column; align-items:flex-start; gap:10px;}
      .secure-chip{width:100%; justify-content:space-between; flex-wrap:wrap;}
    }

    /* -------- Summary cards -------- */
    .summary-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px; margin-bottom: 16px;
    }
    .summary-box {
      background:#fff; border-radius:12px; padding:16px 18px;
      box-shadow:0 2px 8px rgba(0,0,0,.06); border-left:4px solid var(--brand);
    }
    .summary-title { font-size:14px; font-weight:700; color:#6c757d; margin-bottom:6px; }
    .summary-value { font-size:24px; font-weight:800; color:#333; }

    /* -------- Table shell -------- */
    .table-container {
      background:#fff; border-radius:12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .table-header.compact{
      background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e9ecef;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .controls-left{ display:flex; flex:1 1 auto; min-width:320px; }
    .controls-right{ display:flex; align-items:center; gap:10px; }

    .filter-buttons.condensed{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .filter-btn{ padding:6px 12px; font-size:12px; border:1px solid #dee2e6; background:#fff; border-radius:6px; cursor:pointer; }
    .filter-btn:hover{ background:#f1f3f5; }
    .filter-btn.active{ background: var(--brand); color:#fff; border-color: var(--brand); }
    .unpaid-filter{ background:#dc3545; color:#fff; border-color:#dc3545; }
    .unpaid-filter:hover { background:#c82333; color:#fff; }
    .void-filter{ background:#6c757d; color:#fff; border-color:#6c757d; }
    .void-filter:hover{ background:#5a6268; color:#fff; }

    .dropdown-filter{ padding:6px 12px; font-size:12px; min-width:140px; border:1px solid #dee2e6; border-radius:6px; background:#fff; }
    .search-box { padding:8px 12px; border:2px solid #dee2e6; border-radius:6px; font-size:14px; width:250px; }
    .search-box:focus { outline: none; border-color: var(--brand); }
    .record-count { color:#6c757d; font-size:14px; white-space:nowrap; }

    .table-wrapper { overflow-x:auto; max-height:600px; overflow-y:auto; }
    .data-table { width:100%; border-collapse: collapse; font-size:14px; }
    .data-table th {
      background:#f8f9fa; padding:12px; text-align:left;
      font-weight:700; color:#495057; border-bottom:2px solid #e9ecef;
      position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none;
    }
    .data-table td { padding:12px; border-bottom:1px solid #e9ecef; vertical-align: top; }
    .data-table tr:hover { background:#f8f9fa; }
    .void-row { text-decoration: line-through; opacity:.65; background:#f8f9fa!important; }

    /* Notion-like tags */
    .tag { padding:3px 8px; border-radius:3px; font-size:11px; font-weight:600; display:inline-block; margin:2px; }
    .tag.royalties { background:#e3f2fd; color:#1976d2; }
    .tag.publishing { background:#e8f5e8; color:#2e7d32; }
    .tag.master { background:#fff3e0; color:#f57c00; }
    .status { padding:6px 12px; border-radius:16px; font-size:12px; font-weight:600; text-align:center; }

    .loading { text-align:center; padding:60px; color:#6c757d; font-size:16px; }
    .error { text-align:center; padding:40px; color:#721c24; background:#f8d7da; border:1px solid #f5c6cb; border-radius:8px; margin:20px; }
    .no-data { text-align:center; padding:60px; color:#6c757d; }

    .pagination-container {
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 16px; border-top:1px solid #e9ecef; background:#f8f9fa;
    }
    .pagination-info { color:#6c757d; font-size:14px; }
    .pagination-controls { display:flex; gap:10px; align-items:center; }
    .pagination-btn { padding:8px 12px; border:1px solid #dee2e6; background:#fff; border-radius:6px; cursor:pointer; }
    .pagination-btn.active { background:var(--brand); color:#fff; border-color:var(--brand); }

    .export-btn {
      background-color:#4CAF50; color:white; border:none;
      padding:8px 14px; border-radius:6px; cursor:pointer; font-size:14px;
    }
    .export-btn:hover { background-color:#45a049; }

    .refresh-btn {
      position: fixed; bottom: 26px; right: 26px; background: var(--brand);
      color:#fff; border:none; border-radius:50%; width:60px; height:60px;
      cursor:pointer; box-shadow:0 4px 20px rgba(102, 126, 234, 0.4); font-size:20px;
    }
    .refresh-btn:hover { background:#5a6fd8; transform: scale(1.05); }

    /* -------- Tabs -------- */
    .tabs { display:flex; gap:10px; margin: 8px 0 14px; }
    .tab-btn { padding:8px 14px; border:none; background:#e9ecef; border-radius:8px; cursor:pointer; font-weight:700; }
    .tab-btn.active { background: var(--brand); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    /* -------- Charts -------- */
    .charts-grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
    }
    .chart-card{
      background:#fff; border-radius:12px; padding:12px 12px 8px;
      box-shadow:0 2px 8px rgba(0,0,0,.06); min-height:280px;
    }
    .chart-card h3{ margin:6px 8px 10px; font-size:16px; color:#333; }
    .chart-card canvas{ width:100%; height:320px; }
    @media (max-width:600px){ .chart-card canvas{ height:260px; } }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header merged">
    <div class="header-left">
      <h1 class="client-name" id="clientDisplay">Client Dashboard</h1>
      <p class="dashboard-subtitle">Secure data view</p>
    </div>
    <div class="header-right secure-chip">
      <span>🔒 Secure access</span>
      <span class="divider">•</span>
      <span>User: <span id="userEmail">Loading...</span></span>
    </div>
  </div>

  <div class="page">
    <!-- Summary -->
    <div class="summary-container" id="summaryContainer" style="display:none;">
      <div class="summary-box">
        <div class="summary-title">Total Income by Currency</div>
        <div class="summary-value" id="totalIncome">Calculating...</div>
      </div>
      <div class="summary-box">
        <div class="summary-title">Unpaid Income by Currency</div>
        <div class="summary-value" id="unpaidIncome">Calculating...</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-table">Table</button>
      <button class="tab-btn" data-tab="tab-charts">Charts</button>
    </div>

    <!-- TABLE TAB -->
    <div id="tab-table" class="tab-content active">
      <div class="table-container">
        <div class="table-header compact">
          <div class="controls-left">
            <div class="filter-buttons condensed">
              <button class="filter-btn active" onclick="applyDateFilter('all', event)">All Time</button>
              <button class="filter-btn" onclick="applyDateFilter('30', event)">Last 30 Days</button>
              <button class="filter-btn" onclick="applyDateFilter('90', event)">Last 90 Days</button>
              <button class="filter-btn" onclick="applyDateFilter('180', event)">Last 6 Months</button>
              <button class="filter-btn" onclick="applyDateFilter('365', event)">Last 12 Months</button>
              <button class="filter-btn" onclick="applyDateFilter('2025', event)">2025</button>
              <button class="filter-btn" onclick="applyDateFilter('2024', event)">2024</button>
              <button class="filter-btn" onclick="applyDateFilter('2023', event)">2023</button>
              <button class="filter-btn" onclick="applyDateFilter('2022', event)">2022</button>
              <button class="filter-btn" onclick="applyDateFilter('2021', event)">2021</button>

              <button class="filter-btn unpaid-filter" onclick="applyUnpaidFilter()">Unpaid Income</button>
              <button class="filter-btn void-filter" onclick="toggleVoidFilter()">Show Voided</button>

              <select class="dropdown-filter" id="incomeTypeFilter" onchange="applyDropdownFilters()">
                <option value="">All Income Types</option>
              </select>
              <select class="dropdown-filter" id="currencyFilter" onchange="applyDropdownFilters()">
                <option value="">All Currencies</option>
              </select>
            </div>
          </div>

          <div class="controls-right">
            <input type="text" id="searchBox" class="search-box" placeholder="Search data..." />
            <div class="table-actions">
              <button class="export-btn" id="exportCsvBtn" onclick="exportCSV()">⬇ Export CSV</button>
            </div>
            <span id="recordCount" class="record-count"></span>
          </div>
        </div>

        <div id="tableContent">
          <div class="loading">Loading your data...</div>
        </div>

        <div class="pagination-container" id="paginationContainer" style="display:none;">
          <div class="pagination-info" id="paginationInfo"></div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">← Previous</button>
            <span id="pageNumbers"></span>
            <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">Next →</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTS TAB -->
    <div id="tab-charts" class="tab-content">
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Monthly Income Trends</h3>
          <canvas id="monthlyIncomeChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Income by Currency</h3>
          <canvas id="currencyChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Top Vendors by Income</h3>
          <canvas id="vendorChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Income by Type</h3>
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <button class="refresh-btn" onclick="loadData()" title="Refresh Data">↻</button>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    /* ===========================
       State
    ============================ */
    let currentUserEmail = '';
    let currentData = null;
    let filteredData = null;
    let sortOrder = {};
    let currentPage = 1;
    let recordsPerPage = 50;
    let currentDateFilter = 'all';
    let isUnpaidFilter = false;
    let showVoidedItems = false;
    let selectedIncomeType = '';
    let selectedCurrency = '';

    /* ===========================
       Tabs
    ============================ */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
          // Resize charts when opening charts tab
          if (btn.dataset.tab === 'tab-charts') {
            setTimeout(() => Object.values(Charts).forEach(ch => ch?.resize()), 0);
          }
        });
      });
    });

    /* ===========================
       Filters
    ============================ */
    function applyDateFilter(filter, evt) {
      document.querySelectorAll('.filter-btn:not(.unpaid-filter):not(.void-filter)').forEach(btn => btn.classList.remove('active'));
      if (evt && evt.target) evt.target.classList.add('active');
      currentDateFilter = filter;
      isUnpaidFilter = false;
      const unpaidBtn = document.querySelector('.unpaid-filter');
      if (unpaidBtn) unpaidBtn.classList.remove('active');
      applyFilters();
    }
    function applyUnpaidFilter() {
      isUnpaidFilter = !isUnpaidFilter;
      const unpaidBtn = document.querySelector('.unpaid-filter');
      if (isUnpaidFilter) {
        unpaidBtn.classList.add('active');
        document.querySelectorAll('.filter-btn:not(.unpaid-filter):not(.void-filter)').forEach(btn => btn.classList.remove('active'));
        currentDateFilter = 'all';
      } else {
        unpaidBtn.classList.remove('active');
        currentDateFilter = 'all';
        const allTimeBtn = document.querySelector('.filter-btn');
        if (allTimeBtn) allTimeBtn.classList.add('active');
      }
      applyFilters();
    }
    function toggleVoidFilter() {
      showVoidedItems = !showVoidedItems;
      const voidBtn = document.querySelector('.void-filter');
      if (showVoidedItems) { voidBtn.classList.add('active'); voidBtn.textContent = 'Hide Voided'; }
      else { voidBtn.classList.remove('active'); voidBtn.textContent = 'Show Voided'; }
      applyFilters();
    }
    function applyDropdownFilters() {
      const incomeTypeFilter = document.getElementById('incomeTypeFilter');
      const currencyFilter = document.getElementById('currencyFilter');
      selectedIncomeType = incomeTypeFilter ? incomeTypeFilter.value : '';
      selectedCurrency = currencyFilter ? currencyFilter.value : '';
      applyFilters();
    }

    /* ===========================
       Init / Search
    ============================ */
    window.addEventListener('load', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const userEmail = urlParams.get('userEmail');
      if (!userEmail) { showError('No user specified. Please access through proper link.'); return; }
      currentUserEmail = userEmail;
      const userEmailElement = document.getElementById('userEmail');
      if (userEmailElement) userEmailElement.textContent = userEmail;
      loadData();
    });
    document.addEventListener('DOMContentLoaded', function() {
      const searchBox = document.getElementById('searchBox');
      if (searchBox) searchBox.addEventListener('input', filterData);
    });
    function filterData(){ applyFilters(); }

    /* ===========================
       Data Load
    ============================ */
    async function loadData() {
      const tableContent = document.getElementById('tableContent');
      tableContent.innerHTML = '<div class="loading">Verifying access and loading your data...</div>';
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('userEmail');
        const secureKey = urlParams.get('secureKey');
        const timestamp = urlParams.get('timestamp');
        if (!userEmail || !secureKey || !timestamp) throw new Error('Missing authentication parameters');

        const apiUrl = `/api/client-data?userEmail=${encodeURIComponent(userEmail)}&secureKey=${secureKey}&timestamp=${timestamp}`;
        const response = await fetch(apiUrl, { method:'GET', headers:{ 'Accept':'application/json','Cache-Control':'no-cache' } });
        if (!response.ok) {
          let msg = `Access denied: ${response.status}`;
          try { const err = await response.json(); msg = err.error || msg; } catch {}
          throw new Error(msg);
        }
        const data = await response.json();
        if (data.authorizedClient) document.getElementById('clientDisplay').textContent = `${data.authorizedClient} Dashboard`;

        currentData = data;
        populateDropdownFilters(data);
        displayDataAsTable(data);
        updateSummaryBoxes();
        createOrUpdateCharts(); // first render
      } catch (err) {
        showError(`Access Denied: ${err.message}<br><br>Please access this dashboard through the official website.`);
      }
    }

    function populateDropdownFilters(data) {
      if (!data.metadata) return;
      const incomeTypeFilter = document.getElementById('incomeTypeFilter');
      incomeTypeFilter.innerHTML = '<option value="">All Income Types</option>';
      (data.metadata.incomeTypes || []).forEach(type => {
        incomeTypeFilter.innerHTML += `<option value="${type}">${type}</option>`;
      });
      const currencyFilter = document.getElementById('currencyFilter');
      currencyFilter.innerHTML = '<option value="">All Currencies</option>';
      (data.metadata.currencies || []).forEach(currency => {
        currencyFilter.innerHTML += `<option value="${currency}">${currency}</option>`;
      });
    }

    /* ===========================
       Table render / paging / sort
    ============================ */
    function displayDataAsTable(data) {
      const tableContent = document.getElementById('tableContent');
      if (!data.results || data.results.length === 0) {
        tableContent.innerHTML = '<div class="no-data"><h3>No data found</h3></div>';
        return;
      }

      const displayData = filteredData || data.results;
      const totalRecords = displayData.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = startIndex + recordsPerPage;
      const pageData = displayData.slice(startIndex, endIndex);

      updateRecordCount(pageData.length, totalRecords, startIndex + 1, Math.min(endIndex, totalRecords));

      const columnOrder = data.columnOrder || [];
      const columnHeaders = data.columnHeaders || {};

      let properties = [];
      if (columnOrder.length > 0) {
        properties = columnOrder.filter(col => data.results.some(record => record.properties[col]));
      } else {
        const propSet = new Set();
        data.results.forEach(record => {
          Object.keys(record.properties).forEach(prop => { if (prop !== 'Client') propSet.add(prop); });
        });
        properties = Array.from(propSet);
      }

      let html = '<div class="table-wrapper"><table class="data-table"><thead><tr>';
      properties.forEach(prop => {
        const displayName = columnHeaders[prop] || prop;
        html += `<th data-column="${prop}" onclick="sortTable('${prop}')">${displayName}</th>`;
      });
      html += '</tr></thead><tbody>';

      pageData.forEach(record => {
        const isVoided = !!record.properties['VOID?']?.checkbox;
        const rowClass = isVoided ? 'void-row' : '';
        html += `<tr class="${rowClass}">`;
        properties.forEach(prop => {
          const property = record.properties[prop];
          const value = property ? getPropertyValue(property, prop) : '';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      tableContent.innerHTML = html;

      updatePagination(totalPages, totalRecords);
      document.getElementById('summaryContainer').style.display = 'grid';
      updateSummaryBoxes();
      // we rely on applyFilters() to keep charts in sync when filters change
    }

    function sortTable(column) {
      if (!currentData?.results) return;
      sortOrder[column] = (sortOrder[column] === 'asc') ? 'desc' : 'asc';

      Object.keys(sortOrder).forEach(col => {
        if (col !== column) delete sortOrder[col];
      });

      const dataToSort = filteredData || currentData.results;
      dataToSort.sort((a, b) => {
        const aValue = getPropertySortValue(a.properties[column]);
        const bValue = getPropertySortValue(b.properties[column]);
        if (aValue === bValue) return 0;
        const cmp = aValue < bValue ? -1 : 1;
        return sortOrder[column] === 'asc' ? cmp : -cmp;
      });

      if (filteredData) filteredData = dataToSort; else currentData.results = dataToSort;
      currentPage = 1;
      displayDataAsTable(currentData);
      createOrUpdateCharts();
    }

    function getPropertySortValue(property) {
      if (!property) return '';
      switch (property.type) {
        case 'number': return property.number || 0;
        case 'date': return property.date ? new Date(property.date.start).getTime() : 0;
        case 'select': return property.select ? property.select.name.toLowerCase() : '';
        case 'multi_select': return property.multi_select.map(t => t.name).join(' ').toLowerCase();
        case 'title': return property.title.map(t => t.plain_text).join('').toLowerCase();
        case 'rich_text': return property.rich_text.map(t => t.plain_text).join('').toLowerCase();
        case 'relation': return property.relation_titles ? property.relation_titles.toLowerCase() : '';
        default:
          return String(getPropertyValue(property)).toLowerCase().replace(/<[^>]*>/g, '');
      }
    }

    function updatePagination(totalPages, totalRecords) {
      const paginationContainer = document.getElementById('paginationContainer');
      const paginationInfo = document.getElementById('paginationInfo');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageNumbers = document.getElementById('pageNumbers');

      if (totalPages <= 1) { paginationContainer.style.display = 'none'; return; }
      paginationContainer.style.display = 'flex';

      const startRecord = (currentPage - 1) * recordsPerPage + 1;
      const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
      paginationInfo.textContent = `Showing ${startRecord}-${endRecord} of ${totalRecords} records`;

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      let pageNumbersHtml = '';
      const showPages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(showPages / 2));
      let endPage = Math.min(totalPages, startPage + showPages - 1);
      if (endPage - startPage < showPages - 1) startPage = Math.max(1, endPage - showPages + 1);
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        pageNumbersHtml += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
      }
      pageNumbers.innerHTML = pageNumbersHtml;
    }
    function changePage(direction) {
      const totalPages = Math.ceil((filteredData || currentData.results).length / recordsPerPage);
      const newPage = currentPage + direction;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayDataAsTable(currentData);
      }
    }
    function goToPage(page) { currentPage = page; displayDataAsTable(currentData); }

    function updateRecordCount(displayed, total, start, end) {
      const recordCount = document.getElementById('recordCount');
      if (start && end) recordCount.textContent = `${start}-${end} of ${total} records`;
      else if (displayed === total) recordCount.textContent = `${total} record${total !== 1 ? 's' : ''}`;
      else recordCount.textContent = `${displayed} of ${total} record${total !== 1 ? 's' : ''}`;
    }

    /* ===========================
       Filtering function
    ============================ */
    function getFilteredDataByDateAndUnpaid() {
      if (!currentData?.results) return [];
      let filtered = [...currentData.results];

      if (!showVoidedItems) {
        filtered = filtered.filter(r => !(r.properties['VOID?']?.checkbox));
      }
      if (selectedIncomeType) {
        filtered = filtered.filter(r => (r.properties['Income Type']?.select?.name) === selectedIncomeType);
      }
      if (selectedCurrency) {
        filtered = filtered.filter(r => (r.properties['Currency']?.select?.name) === selectedCurrency);
      }
      if (currentDateFilter !== 'all') {
        filtered = filtered.filter(r => {
          const d = r.properties['Invoice date']?.date?.start;
          if (!d) return false;
          const recDate = new Date(d);
          const now = new Date();
          if (currentDateFilter === '30')  return recDate >= new Date(now.getTime() - 30*24*60*60*1000);
          if (currentDateFilter === '90')  return recDate >= new Date(now.getTime() - 90*24*60*60*1000);
          if (currentDateFilter === '180') return recDate >= new Date(now.getTime() - 180*24*60*60*1000);
          if (currentDateFilter === '365') return recDate >= new Date(now.getTime() - 365*24*60*60*1000);
          return recDate.getFullYear().toString() === currentDateFilter;
        });
      }
      if (isUnpaidFilter) {
        filtered = filtered.filter(r => {
          const val = r.properties['Amount Received']?.number;
          return val === undefined || val === null || val === 0;
        });
      }
      return filtered;
    }

    function applyFilters() {
      if (!currentData) return;
      filteredData = getFilteredDataByDateAndUnpaid();

      const searchBox = document.getElementById('searchBox');
      const searchTerm = searchBox ? searchBox.value.toLowerCase().trim() : '';
      if (searchTerm) {
        filteredData = filteredData.filter(record => {
          const searchableText = Object.values(record.properties).map(property => {
            if (!property) return '';
            return String(getPropertyValue(property)).toLowerCase().replace(/<[^>]*>/g, '');
          }).join(' ');
          return searchableText.includes(searchTerm);
        });
      }

      currentPage = 1;
      displayDataAsTable(currentData);
      createOrUpdateCharts(); // keep charts in sync
    }

    /* ===========================
       Summary boxes
    ============================ */
    function getNumberProp(record, keys) {
      for (const k of keys) {
        const p = record.properties?.[k];
        if (p && p.type === 'number' && typeof p.number === 'number') return p.number;
      }
      return null;
    }
    function getSelectNameProp(record, keys) {
      for (const k of keys) {
        const p = record.properties?.[k];
        if (p && p.type === 'select' && p.select?.name) return p.select.name;
      }
      return 'Unknown';
    }
    function updateSummaryBoxes() {
      if (!currentData?.results) return;
      const rows = filteredData || currentData.results;
      const totalByCurr = {};
      const unpaidByCurr = {};

      rows.forEach(rec => {
        const voidProp = rec.properties?.['VOID?'];
        if (voidProp?.checkbox) return;
        const net = getNumberProp(rec, ['Net Amount','Net']);
        if (net === null) return;
        const received = getNumberProp(rec, ['Amount Received','Received Amount']);
        const invCurr = getSelectNameProp(rec, ['Currency (Inv/Stmt)','Currency','Currency (Invoice)']);
        totalByCurr[invCurr] = (totalByCurr[invCurr] || 0) + net;
        if (received === null || received === 0) unpaidByCurr[invCurr] = (unpaidByCurr[invCurr] || 0) + net;
      });

      const totalEntries  = Object.entries(totalByCurr);
      const unpaidEntries = Object.entries(unpaidByCurr);

      document.getElementById('totalIncome').textContent =
        totalEntries.length ? totalEntries.map(([c,a]) => `${c} ${formatNumber(a)}`).join(' | ') : 'No data';

      document.getElementById('unpaidIncome').textContent =
        unpaidEntries.length ? unpaidEntries.map(([c,a]) => `${c} ${formatNumber(a)}`).join(' | ') : 'All paid';
    }

    /* ===========================
       Property render helpers
    ============================ */
    function formatNumber(num) {
      if (num === null || num === undefined || num === '') return '';
      return Number(num).toLocaleString('en-US',{ minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function formatPercentage(num) {
      if (num === null || num === undefined || num === '') return '';
      return (Number(num) * 100).toFixed(2) + '%';
    }
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const day = String(date.getDate()).padStart(2,'0');
      return `${day} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }
    function getTagClass(tagName) {
      const name = tagName.toLowerCase().replace(/\s+/g, '-');
      const map = { 'royalties':'royalties', 'publishing':'publishing', 'master':'master',
                    'royalties---publishing':'publishing', 'royalties---master':'master' };
      if (map[name]) return map[name];
      return 'royalties';
    }
    function getPropertyValue(property, columnName) {
      if (!property) return '';
      if (columnName === 'Commission %' && property.type === 'number') return formatPercentage(property.number);

      switch (property.type) {
        case 'title': return property.title.map(t => t.plain_text).join('');
        case 'rich_text': return property.rich_text.map(t => t.plain_text).join('');
        case 'number': return property.number !== null ? formatNumber(property.number) : '';
        case 'select':
          if (property.select) {
            const tagClass = getTagClass(property.select.name);
            return `<span class="tag ${tagClass}">${property.select.name}</span>`;
          }
          return '';
        case 'multi_select':
          return property.multi_select.map(tag => `<span class="tag ${getTagClass(tag.name)}">${tag.name}</span>`).join(' ');
        case 'date': return property.date ? formatDate(property.date.start) : '';
        case 'checkbox': return property.checkbox ? '✅' : '❌';
        case 'url': return property.url ? `<a href="${property.url}" target="_blank" style="color: var(--brand);">🔗 Link</a>` : '';
        case 'email': return property.email ? `<a href="mailto:${property.email}" style="color: var(--brand);">📧 ${property.email}</a>` : '';
        case 'phone_number': return property.phone_number || '';
        case 'status': return property.status ? `<span class="status">${property.status.name}</span>` : '';
        case 'people': return (property.people||[]).map(p => `👤 ${p.name}`).join(', ');
        case 'relation':
          if (property.relation?.length > 0) return property.relation_titles || `${property.relation.length} linked item(s)`;
          return '';
        case 'formula':
          if (!property.formula) return '';
          const f = property.formula;
          if (f.type === 'string') return f.string || '';
          if (f.type === 'number') return columnName === 'Commission %' ? formatPercentage(f.number) : formatNumber(f.number);
          if (f.type === 'boolean') return f.boolean ? '✅' : '❌';
          if (f.type === 'date') return f.date ? formatDate(f.date.start) : '';
          return '';
        case 'rollup':
          if (!property.rollup) return '';
          if (property.rollup.type === 'number') return columnName === 'Commission %' ? formatPercentage(property.rollup.number) : formatNumber(property.rollup.number);
          if (property.rollup.type === 'date') return property.rollup.date ? formatDate(property.rollup.date.start) : '';
          if (property.rollup.type === 'array') {
            return property.rollup.array.map(item => {
              if (item.type === 'number') return formatNumber(item.number);
              if (item.type === 'rich_text') return item.rich_text.map(t=>t.plain_text).join('');
              if (item.type === 'title') return item.title.map(t=>t.plain_text).join('');
              return '';
            }).filter(Boolean).join(', ');
          }
          return '';
        case 'files': return (property.files || []).map(f=>f.name || f.file?.url || f.external?.url).join('; ');
        case 'created_time': return formatDate(property.created_time);
        case 'last_edited_time': return formatDate(property.last_edited_time);
        case 'created_by': return property.created_by?.name || 'Unknown';
        case 'last_edited_by': return property.last_edited_by?.name || 'Unknown';
        default: return '';
      }
    }

    function showError(message) {
      const tableContent = document.getElementById('tableContent');
      tableContent.innerHTML = `<div class="error">${message}</div>`;
    }

    /* ===========================
       CSV Export
    ============================ */
    function csvEscape(val){ if (val===null || val===undefined) return '""'; return `"${String(val).replace(/\r?\n|\r/g,' ').replace(/"/g,'""')}"`; }
    function getPlainValue(property, columnName){
      if (!property) return '';
      switch (property.type) {
        case 'title':      return property.title.map(t=>t.plain_text).join('');
        case 'rich_text':  return property.rich_text.map(t=>t.plain_text).join('');
        case 'number':     return property.number ?? '';
        case 'select':     return property.select?.name || '';
        case 'multi_select': return property.multi_select.map(t=>t.name).join('; ');
        case 'date':       return property.date ? formatDate(property.date.start) : '';
        case 'checkbox':   return property.checkbox ? 'TRUE' : 'FALSE';
        case 'url':        return property.url || '';
        case 'email':      return property.email || '';
        case 'phone_number': return property.phone_number || '';
        case 'status':     return property.status?.name || '';
        case 'people':     return (property.people||[]).map(p=>p.name).join('; ');
        case 'relation':
          if (property.relation_titles) return property.relation_titles;
          if (property.relation?.length) return `${property.relation.length} linked`;
          return '';
        case 'formula': {
          const f = property.formula; if (!f) return '';
          if (f.type==='string') return f.string || '';
          if (f.type==='number') return f.number ?? '';
          if (f.type==='boolean') return f.boolean ? 'TRUE' : 'FALSE';
          if (f.type==='date') return f.date ? formatDate(f.date.start) : '';
          return '';
        }
        case 'rollup': {
          const r = property.rollup; if (!r) return '';
          if (r.type==='number') return r.number ?? '';
          if (r.type==='date')   return r.date ? formatDate(r.date.start) : '';
          if (r.type==='array'){
            return r.array.map(item=>{
              if (item.type==='number') return item.number ?? '';
              if (item.type==='rich_text') return item.rich_text.map(t=>t.plain_text).join('');
              if (item.type==='title') return item.title.map(t=>t.plain_text).join('');
              return '';
            }).filter(Boolean).join('; ');
          }
          return '';
        }
        case 'files': return (property.files||[]).map(f=>f.name || f.file?.url || f.external?.url).join('; ');
        case 'created_time':     return formatDate(property.created_time);
        case 'last_edited_time': return formatDate(property.last_edited_time);
        case 'created_by':       return property.created_by?.name || '';
        case 'last_edited_by':   return property.last_edited_by?.name || '';
        default: return '';
      }
    }
    function getActiveColumns(){
      if (!currentData) return [];
      const data = currentData;
      const order = data.columnOrder || [];
      if (order.length) return order.filter(col => data.results.some(r => r.properties[col]));
      const set = new Set();
      data.results.forEach(r => { Object.keys(r.properties||{}).forEach(p => { if (p!=='Client') set.add(p); }); });
      return Array.from(set);
    }
    function getActiveRows(){ return (filteredData || (currentData ? currentData.results : [])) || []; }
    function exportCSV(){
      try {
        if (!currentData?.results) { alert('Data not loaded yet.'); return; }
        const cols = getActiveColumns();
        const headersMap = currentData.columnHeaders || {};
        const headerRow = cols.map(c => csvEscape(headersMap[c] || c)).join(',');
        const rows = getActiveRows();
        const csvLines = [headerRow];
        rows.forEach(rec => {
          const row = cols.map(col => csvEscape(getPlainValue(rec.properties?.[col], col))).join(',');
          csvLines.push(row);
        });
        const csv = '\uFEFF' + csvLines.join('\n'); // BOM for Excel
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        const client = (document.getElementById('clientDisplay')?.textContent || 'data').replace(/\s+Dashboard$/,'').trim();
        a.href = url; a.download = `dashboard-${client}-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      } catch (e){ console.error('CSV export failed:', e); alert('Sorry, CSV export failed.'); }
    }

    /* ===========================
       Charts
    ============================ */
    let Charts = { monthly:null, currency:null, vendor:null, type:null };

    function pickNumber(rec, keys) {
      for (const k of keys) {
        const p = rec.properties?.[k];
        if (p?.type === 'number' && typeof p.number === 'number') return p.number;
        if (p?.type === 'formula' && p.formula?.type === 'number' && typeof p.formula.number === 'number') return p.formula.number;
        if (p?.type === 'rollup' && p.rollup?.type === 'number' && typeof p.rollup.number === 'number') return p.rollup.number;
      }
      return null;
    }
    function pickSelectName(rec, keys) {
      for (const k of keys) {
        const p = rec.properties?.[k];
        if (p?.type === 'select' && p.select?.name) return p.select.name;
      }
      return 'Unknown';
    }
    function pickText(rec, keys) {
      for (const k of keys) {
        const p = rec.properties?.[k];
        if (!p) continue;
        if (p.type === 'title') return p.title.map(t=>t.plain_text).join('');
        if (p.type === 'rich_text') return p.rich_text.map(t=>t.plain_text).join('');
        if (p.type === 'select') return p.select?.name || '';
        if (p.type === 'formula' && p.formula?.type === 'string') return p.formula.string || '';
      }
      return '';
    }
    function buildAggregates(rows) {
      const monthlyMap = new Map();       // 'YYYY-MM' -> total
      const currencyMap = new Map();      // 'GBP' -> total
      const vendorMap = new Map();        // 'Vendor' -> total
      const typeMap = new Map();          // 'Income Type' -> total

      rows.forEach(rec => {
        if (!showVoidedItems && rec.properties?.['VOID?']?.checkbox) return;
        const net = pickNumber(rec, ['Net Amount','Net']); if (net === null) return;

        const d = rec.properties?.['Invoice date']?.date?.start;
        const dt = d ? new Date(d) : null;
        const yymm = dt ? `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}` : 'Unknown';

        const currency = pickSelectName(rec, ['Currency (Inv/Stmt)','Currency','Currency (Invoice)']);
        const vendor   = pickText(rec, ['Vendor1','Vendor']);
        const incomeType = pickSelectName(rec, ['Income Type']);

        monthlyMap.set(yymm, (monthlyMap.get(yymm) || 0) + net);
        currencyMap.set(currency, (currencyMap.get(currency) || 0) + net);
        vendorMap.set(vendor || 'Unknown', (vendorMap.get(vendor || 'Unknown') || 0) + net);
        typeMap.set(incomeType || 'Unknown', (typeMap.get(incomeType || 'Unknown') || 0) + net);
      });

      const monthlyLabels = Array.from(monthlyMap.keys()).sort();
      const monthlyVals = monthlyLabels.map(k => monthlyMap.get(k));
      const currencyEntries = Array.from(currencyMap.entries()).sort((a,b)=>b[1]-a[1]);
      const currencyLabels = currencyEntries.map(e=>e[0]);
      const currencyVals = currencyEntries.map(e=>e[1]);
      const vendorEntries = Array.from(vendorMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const vendorLabels = vendorEntries.map(e=>e[0]);
      const vendorVals = vendorEntries.map(e=>e[1]);
      const typeEntries = Array.from(typeMap.entries()).sort((a,b)=>b[1]-a[1]);
      const typeLabels = typeEntries.map(e=>e[0]);
      const typeVals = typeEntries.map(e=>e[1]);

      return { monthlyLabels, monthlyVals, currencyLabels, currencyVals, vendorLabels, vendorVals, typeLabels, typeVals };
    }

    function createOrUpdateCharts() {
      const rows = getActiveRows();
      const { monthlyLabels, monthlyVals, currencyLabels, currencyVals, vendorLabels, vendorVals, typeLabels, typeVals } = buildAggregates(rows);

      const gold = '#D4A017', teal = '#20B2AA', purple = '#A569BD', orange = '#FF8C00', blue = '#6CA6CD';

      // Monthly line
      if (!Charts.monthly) {
        Charts.monthly = new Chart(document.getElementById('monthlyIncomeChart'), {
          type:'line',
          data:{ labels:monthlyLabels, datasets:[{ label:'Net Income', data:monthlyVals, borderColor:gold, backgroundColor:'rgba(212,160,23,.18)', fill:true, tension:.25, pointRadius:3 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.dataset.label}: ${formatNumber(ctx.parsed.y)}` } } }, scales:{ y:{ ticks:{ callback:(v)=>formatNumber(v) } } } }
        });
      } else {
        Charts.monthly.data.labels = monthlyLabels;
        Charts.monthly.data.datasets[0].data = monthlyVals;
        Charts.monthly.update();
      }

      // Currency pie
      if (!Charts.currency) {
        Charts.currency = new Chart(document.getElementById('currencyChart'), {
          type:'pie',
          data:{ labels:currencyLabels, datasets:[{ data:currencyVals, backgroundColor:[gold, blue, purple, teal, orange] }] },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      } else {
        Charts.currency.data.labels = currencyLabels;
        Charts.currency.data.datasets[0].data = currencyVals;
        Charts.currency.update();
      }

      // Vendors horizontal bar
      if (!Charts.vendor) {
        Charts.vendor = new Chart(document.getElementById('vendorChart'), {
          type:'bar',
          data:{ labels:vendorLabels, datasets:[{ label:'Net Income', data:vendorVals, backgroundColor:gold }] },
          options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=>` ${formatNumber(ctx.parsed.x)}` } } }, scales:{ x:{ ticks:{ callback:(v)=>formatNumber(v) } } } }
        });
      } else {
        Charts.vendor.data.labels = vendorLabels;
        Charts.vendor.data.datasets[0].data = vendorVals;
        Charts.vendor.update();
      }

      // Income type doughnut
      if (!Charts.type) {
        Charts.type = new Chart(document.getElementById('typeChart'), {
          type:'doughnut',
          data:{ labels:typeLabels, datasets:[{ data:typeVals, backgroundColor:[teal,gold,purple,orange,blue] }] },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      } else {
        Charts.type.data.labels = typeLabels;
        Charts.type.data.datasets[0].data = typeVals;
        Charts.type.update();
      }
    }

    /* expose for HTML onclicks */
    window.loadData = loadData;
  </script>
</body>
</html>
